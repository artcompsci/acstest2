ACSDOC revision work memo

J. Makino Nov 17 2005

Here I try to record as much as thoughts and actual works.

First, there need to an easy way to record changes. It would be okay
to use svn to record every changes. So one liner

svn commit -m "working change for acsdoc2" --non-interactive

would do the recording. Test:

acssvn commit -m "working-change-for-acsdoc2"
Adding         kali/vol/documentation/acsdoc2.rb
Deleting       kali/vol/documentation/ascdoc2.rb

Fine, except that it takes rather long time.

The following will print the change between the latest committed
version and last change:

svn diff -r COMMITTED acsdoc2.rb

Thus, by having a script:

#!/bin/csh -f
setenv SVN_SSH "ssh -l acs"
setenv LANG C
date >> acsdoc-rev-memo
svn diff -r COMMITTED acsdoc2.rb >> acsdoc-rev-memo
svn commit -m "working-change-for-acsdoc2" --non-interactive >> acsdoc-rev-memo

I should be able to record all changes in the file acsdoc-rev-memo
(which is this file)

Fri Nov 18 06:13:23 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1369)
+++ acsdoc2.rb	(working copy)
@@ -20,6 +20,8 @@
 # string as an argument
 #
 # 2005/11/17 created acsdoc2.rb
+# test for more change
+# more changes
 #
 #==============================================================================
 #$DEBUG=1
Sending        documentation/acsdoc2.rb
Transmitting file data .
Committed revision 1370.

Okay, this works.

Currently, acsdoc for HTML generation works in the following steps:

1) create .foo.cp files, from foo.cp file
   it also generates .bar.rb files from bar.rb files. This part need
    not be changed
  
2) calling rdoc for .foo.cp files

3) doing many postprocessing....

So let us first make the following changes:

1) instead of making .foo.cp files, create foo.html files
2) do not call rdoc
3) do not remove .foo.cp files (since they are not created)

Questions: Should HTML files be at the same directory as cp files?
Well, perhaps it is, since there would not be other good place...

First the first step

Fri Nov 18 06:49:49 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1370)
+++ acsdoc2.rb	(working copy)
@@ -1,18 +1,10 @@
 #!/usr/bin/ruby
 #
-# acsdoc.rb
+# acsdoc2.rb
 #
-# This script takes a number of files and runs rdoc ("rdoc.sourceforge.net")
-# on them.  All options normally given to rdoc on the command line are
-# passed on to rdoc.
+# This script takes a number of files and make HTML or LaTeX files from them. 
+# usage:  ruby acsdoc.rb [--tolatex]   [file]...
 #
-# As an internal detail, this script generates for each .cp file "filename.cp"
-# a temporary file ".filename.cp", which is removed before the script finishes.
-# If acsdoc.rb is invoked with the option "--keep-dot-files", these temporary
-# files are not removed
-#    s
-# usage:  ruby acsdoc.rb [--keep-dot-files] [--tolatex]  [rdoc option]... [file]...
-#
 # 2004/3/22 Major rewrite to make it more easily extensible.
 #
 # Basic change: all functions are changed to (if not already designed
@@ -1637,7 +1629,6 @@
 load_old_aux
 load_volindex
 del_flag = true
-del_file_list = Array.new
 tolatex_flag = false
 
 ARGV.collect! do |a|
@@ -1645,14 +1636,13 @@
     extention = "."+$1
     if FileTest.size?(a)
       unless tolatex_flag 
-	dot_a = File.dirname(a)+"/."+File.basename(a);
+	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
       else
 	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".tex"
       end
       $current_cp_filename = a
       prep_cp(a, dot_a, tolatex_flag)
       a = dot_a
-      del_file_list.push(dot_a)
     else
       a = ""
     end
@@ -1679,9 +1669,6 @@
       a = ""
     end
     a
-  elsif a == "--keep-dot-files"
-    del_flag = false
-    a = ""
   elsif a == "--tolatex"
     tolatex_flag = true
     del_flag = false
@@ -1701,22 +1688,11 @@
 end
 
 unless tolatex_flag
-  print "rdoc #{coptions} #{ARGV.join(" ")} \n" 
-  unless system("rdoc #{coptions} #{ARGV.join(" ")}") 
-# This part is to work around some unfixed bug in rdoc
-    system("touch .zdummy")
-    system("rdoc #{coptions} #{ARGV.join(" ")} .zdummy") 
-  end
-  add_toc
-  process_css
-  dump_aux
+#  add_toc
+#  process_css
+#  dump_aux
 end
 
-create_navigations_for_cp_files(ARGV)
-if del_flag
-  del_file_list.each do |f|
-    File.delete(f)
-  end
-end
+#create_navigations_for_cp_files(ARGV)
 
 # :segment end:
Adding         documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1371.

<yebisu:/home/makino/acs/kali/vol/documentation>acsdoc2.rb ch02.ok
acsdoc2.rb:491: warning: regexp has `}' without escape
acsdoc2.rb:1424: warning: regexp has `}' without escape
Loading initialization file .acsdocinitrc
Common initialization file loaded from etc/acsdocinitrc
acsdoc2.rb:1698: undefined local variable or method `del_file_list' for #<Object:0xb7d399c0 @previous_is_command=nil> (NameError)
<yebisu:/home/makino/acs/kali/vol/documentation>up

Fri Nov 18 07:02:51 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1372.

Fri Nov 18 07:09:07 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1373.

Now HTML file is made, but with the old content of .foo.cp file

Question is how to structure the source code. Current structure of the
make code is:

    unless tolatex_flag
      s = convert_link_to_rdoc_style(instring,dirname)
    else
      s = instring
    end
    tmpstring=prep_cp_string(s,dirname,infile).split("\n");
    if tolatex_flag
b      tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
    else
      tmp2= Rdoctotex::latex_process_tex_mathmarkup(tmpstring)
      tmp2= find_and_process_tex_inlines(tmp2,dirname);
      tmp2= find_and_process_tex_equations(tmp2,dirname);
      tmp2= find_and_process_figures(tmp2,dirname);
      tmp2= find_and_process_generic_tag(tmp2,dirname,"nosectionnumber",
					 "process_nosectionnumber")
      tmp2= process_toc(tmp2,infile);
      tmp2= process_section_headers(tmp2,infile)
      tmp2= process_tex_labels(tmp2,dirname);
      tmp2= process_tex_weblinks(tmp2)
      tmp2= process_some_special_characters(tmp2)
    end

So, basically by changing the functions in the last else block, I can
generate HTML directly. I guess I just try that for now.

      tmp2= find_and_process_tex_inlines(tmp2,dirname);

This one actually touch process_tex_inlines
which then call process_texcod
Fri Nov 18 09:21:37 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1371)
+++ acsdoc2.rb	(working copy)
@@ -878,7 +878,7 @@
       raise "Failed to create the jpeg file #{texbase}.jpeg"
     end
     @@imgcount+=1
-    "link:../#{imgname}"
+    "<IMG SRC=#{imgname}"
   end
 
   def process_tex_inlines(s,instring,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1374.

One bug found: IMG tag not closed.

Fri Nov 18 09:23:46 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1374)
+++ acsdoc2.rb	(working copy)
@@ -878,7 +878,7 @@
       raise "Failed to create the jpeg file #{texbase}.jpeg"
     end
     @@imgcount+=1
-    "<IMG SRC=#{imgname}"
+    "<IMG SRC=#{imgname}>"
   end
 
   def process_tex_inlines(s,instring,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1375.

Now find_and_process_tex_inlines seems to do something reasonable,
making for example 

 It seems to fail in a strange way in some cases. This is apparently
  a problem with rdoc. For example, <IMG SRC=.imgs/1.jpeg>
  but I suspect after \<tex> this </tex>, the next thing will fail
  <IMG SRC=.imgs/2.jpeg> for unknown reason.

Next thing is  find_and_process_tex_equations. This seems to be done
correctly by previous one. No changes made.

Now figures:  find_and_process_figures. It should create something like:

<p>
<a name=tiogaicon> <img ALIGN="middle"
src="../../../.imgs/1_tioga_icon.ps.jpeg">
</p>
<pre>
 Figure 1: Icon for Tioga system
</pre>

Fri Nov 18 09:35:06 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1379.

Need to change copy_figure_file

Fri Nov 18 10:05:06 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1381)
+++ acsdoc2.rb	(working copy)
@@ -1003,7 +1003,7 @@
     p imgname  if $DEBUG
     system "convert #{dirname}/#{figurefilename} #{imgname}"
     system "mv -f #{imgname}.0 #{imgname}"if File.exist?(imgname + ".0")
-    "../"+imgname
+    imgname
   end
 
   @@figure_number =0
@@ -1014,7 +1014,7 @@
     figurefilename,size,label = a[1],a[2],a[3]
     @@tex_labels[label]=@@figure_number
     @@tex_labels_filename[label]=$current_cp_filename
-    namelabel = "<name>" + label + "</name>\n"
+    namelabel = "<a name=#{label}>\n"
     caption = ""
     while (s = instring.shift ) =~ /\S/
       caption += s + "\n"
@@ -1023,8 +1023,8 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    namelabel + "link:"+filename_to_link+"\n\n Figure " +
-      @@figure_number.to_s + ": " + caption + "\n\n"
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>+
+    "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1382.
Fri Nov 18 10:06:07 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1382)
+++ acsdoc2.rb	(working copy)
@@ -1023,7 +1023,7 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>+
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>"+
     "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1383.

Figure seems to be okay.

Generic tag:

      tmp2= find_and_process_generic_tag(tmp2,dirname,"nosectionnumber",
					 "process_nosectionnumber")

process_nosectionnumber does something...

Currently it does not do anything. Seems to be okay to ignore it.

      tmp2= process_toc(tmp2,infile);

This will create: TOCTOCTOCTOC, which should be post-processed (I think)

tmp2= process_section_headers(tmp2,infile)

Fri Nov 18 10:25:05 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1383)
+++ acsdoc2.rb	(working copy)
@@ -1108,7 +1108,7 @@
       sectionlabel="rdocsect"+@@sectionheadercounter.to_s
       @@sectionheaders.push [sectionlabel,sectionlevel,sectionname,filename]
       @@sectionheadercounter+= 1
-      s+"\n<name>" + sectionlabel + "</name>\n"
+      s+"<name>" + sectionlabel + "</name>\n"
     }
   end
 
@@ -1121,7 +1121,7 @@
       if str =~ /^\s*:label:\s/
 	labeltext=str.split[1]
         labeltext = "sect:"+labeltext if labeltext !~ /^sect/
-        ostring+= "<name>#{labeltext}</name>"
+        ostring+= "<a name=#{labeltext}>"
 	@@tex_labels[labeltext]=lastsectionnumber
         @@tex_labels_filename[labeltext]=$current_cp_filename
 	print "Label #{labeltext} as #{lastsectionnumber}\n"
@@ -1145,7 +1145,7 @@
 	  @@section_label_table[labeltext]=sectionlabel
           lastsectionnumber=number_label[0,number_label.length-1]
 	  labeltext=nil
-	  "="*sectionlevel+ " "+sectionname+ "\n<name>" + sectionlabel + "</name>\n"
+	   "<h2> "+sectionname+ "</h2>\n<a name=" + sectionlabel + ">\n"
 	} 
 	ostring +=x
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1384.


      tmp2= process_tex_labels(tmp2,dirname);

Fri Nov 18 10:33:52 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1384)
+++ acsdoc2.rb	(working copy)
@@ -1077,20 +1077,21 @@
         reallabel = $2
         filename, tag=getauxlabel(dirname,reallabel)
         if filename
-          "("+tag+")["+filename+"\#"+reallabel+"]"
+          "<a href=#{filename}\##{reallabel}>#{tag}>"
         else
           "(unknown label #{label})"
         end
       elsif @@tex_labels[label] 
-#        if @@tex_labels_filename[label]==$current_cp_filename
-#          "<ntaga>"+ label + "</ntaga><ntagb>"+ @@tex_labels[label].to_s+ "</ntagb>"
-#        else
-        "("+@@tex_labels[label].to_s+")["+
-          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
-#        end
+#        "("+@@tex_labels[label].to_s+")["+
+#          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
+          "<a href="+to_rdocname(@@tex_labels_filename[label])+"\#"+label+">"+
+          @@tex_labels[label].to_s+">"
       elsif @@old_tex_labels[label]
-          "("+@@old_tex_labels[label].to_s+")["+
-            to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+"]"
+#          "("+@@old_tex_labels[label].to_s+")["+
+#            
+          "<a href="+
+             to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+">"+
+          @@old_tex_labels[label].to_s+">"
       else
         "(unknown label #{label})"
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1385.

The form of the link looks okay. The file name is not.

Fri Nov 18 10:38:53 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1385)
+++ acsdoc2.rb	(working copy)
@@ -1691,7 +1691,7 @@
 unless tolatex_flag
 #  add_toc
 #  process_css
-#  dump_aux
+   dump_aux
 end
 
 #create_navigations_for_cp_files(ARGV)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1386.

local file names: to_rdocname
nonlocal file names: getauxlabel?

Fri Nov 18 10:46:11 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1386)
+++ acsdoc2.rb	(working copy)
@@ -1043,8 +1043,12 @@
     ostring
   end
 
-  def to_rdocname(name)
-    "_"+name.gsub(/\./,"_")+".html"
+#  def to_rdocname(name)
+#    "_"+name.gsub(/\./,"_")+".html"
+#  end
+
+  def to_htmlname(a)
+    File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
   end
 
   def getauxlabel(dirname, label)
@@ -1053,8 +1057,8 @@
       x = Marshal.load(open(dirname+"/"+@@auxfilename,"r"))
       tex_labels, tex_labels_filename,  section_label_table,  sectionheaders = x
       if tex_labels[label]
-        location = "../../../"+dirname+"/doc/files/_/"+
-          to_rdocname(tex_labels_filename[label])
+        location = "../"+dirname+"/"+
+          to_htmlname(tex_labels_filename[label])
         newtag=@@volindex[dirname[3,dirname.length]]
         tag =  newtag ? "v"+newtag.to_s : dirname+"."
         return [location,tag+tex_labels[label].to_s]
@@ -1084,13 +1088,13 @@
       elsif @@tex_labels[label] 
 #        "("+@@tex_labels[label].to_s+")["+
 #          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
-          "<a href="+to_rdocname(@@tex_labels_filename[label])+"\#"+label+">"+
+          "<a href="+to_htmlname(@@tex_labels_filename[label])+"\#"+label+">"+
           @@tex_labels[label].to_s+">"
       elsif @@old_tex_labels[label]
 #          "("+@@old_tex_labels[label].to_s+")["+
 #            
           "<a href="+
-             to_rdocname(@@old_tex_labels_filename[label])+"\#"+label+">"+
+             to_htmlname(@@old_tex_labels_filename[label])+"\#"+label+">"+
           @@old_tex_labels[label].to_s+">"
       else
         "(unknown label #{label})"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1387.

    acsdoc2.rb:1051:in `to_htmlname': undefined local variable or method `extention' for #<Object:0xb7d399c0 @previous_is_command=nil> (NameError)
        from acsdoc2.rb:1091:in `process_tex_labels'
        from acsdoc2.rb:1076:in `gsub'
        from acsdoc2.rb:1076:in `process_tex_labels'
        from acsdoc2.rb:1223:in `prep_cp'
        from acsdoc2.rb:1649
        from acsdoc2.rb:1639:in `collect!'
        from acsdoc2.rb:1639

Error: $current_extention created to fix. Not quite clean...

Fri Nov 18 10:49:37 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1387)
+++ acsdoc2.rb	(working copy)
@@ -1048,7 +1048,7 @@
 #  end
 
   def to_htmlname(a)
-    File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
+    File.dirname(a)+"/"+File.basename(a,$current_extention)+ ".html"
   end
 
   def getauxlabel(dirname, label)
@@ -1639,6 +1639,7 @@
 ARGV.collect! do |a|
   if a =~ /\.((cp)|(ok))$/
     extention = "."+$1
+    $current_extention=extention
     if FileTest.size?(a)
       unless tolatex_flag 
 	dot_a = File.dirname(a)+"/"+File.basename(a,extention)+ ".html"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1388.
Fri Nov 18 10:51:46 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1388)
+++ acsdoc2.rb	(working copy)
@@ -1057,7 +1057,7 @@
       x = Marshal.load(open(dirname+"/"+@@auxfilename,"r"))
       tex_labels, tex_labels_filename,  section_label_table,  sectionheaders = x
       if tex_labels[label]
-        location = "../"+dirname+"/"+
+        location = dirname+"/"+
           to_htmlname(tex_labels_filename[label])
         newtag=@@volindex[dirname[3,dirname.length]]
         tag =  newtag ? "v"+newtag.to_s : dirname+"."
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1389.

lables and filenames now looks okay.

tmp2= process_tex_weblinks(tmp2)



Fri Nov 18 10:57:30 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1389)
+++ acsdoc2.rb	(working copy)
@@ -1174,10 +1174,10 @@
       if linktext =~ /(.*)\|(.*)/m
 	url=($1)
 	text=$2
-	s="(#{text})[#{url}]"
       else
-	s="(#{linktext})[#{linktext}]"
+        url=text=linktext
       end
+      s="<a href=#{url}>#{text}>"
       blank+s.gsub(/\s/m," ")
     }
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1390.

This creates:

<a href=http:www.artcompsci.org>ACS homepage>.

Fri Nov 18 10:59:08 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1390)
+++ acsdoc2.rb	(working copy)
@@ -1177,7 +1177,7 @@
       else
         url=text=linktext
       end
-      s="<a href=#{url}>#{text}>"
+      s="<a href=#{url}>#{text}</a>"
       blank+s.gsub(/\s/m," ")
     }
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1391.

This creates:

<a href=http:www.artcompsci.org>ACS homepage</a>.


  tmp2= process_some_special_characters(tmp2)
 This one looks at: expand()

 Not sure if this is meaningful or not...

Now, things which is done in tex conversion must be added:


    s=process_include(instring)

This is probably the same

Fri Nov 18 11:06:53 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1391)
+++ acsdoc2.rb	(working copy)
@@ -1223,6 +1223,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
+      tmp2= Rdoctotex::process_include(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1392.
Fri Nov 18 11:08:01 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1392)
+++ acsdoc2.rb	(working copy)
@@ -1213,6 +1213,7 @@
       tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
     else
       tmp2= Rdoctotex::latex_process_tex_mathmarkup(tmpstring)
+      tmp2= Rdoctotex::process_include(tmp2)
       tmp2= find_and_process_tex_inlines(tmp2,dirname);
       tmp2= find_and_process_tex_equations(tmp2,dirname);
       tmp2= find_and_process_figures(tmp2,dirname);
@@ -1223,7 +1224,6 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2= Rdoctotex::process_include(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1393.

Seems to do something reasonable

    s=latex_process_tex_mathmarkup(s)
    s=latex_process_tex_equations(s)
    s=latex_process_tex_weblinks(s)
    s=latex_find_and_process_figures(s,dirname)

These are done already

    s=process_single_paragraphs_lists_etc(s,0,0,1,0)

What is this???

Fri Nov 18 11:19:45 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1393)
+++ acsdoc2.rb	(working copy)
@@ -570,6 +570,98 @@
   @@section_label_table={}
 
   @@section_counters=[]
+
+  @@listtypes=[
+    ["paragraph","p"],
+    ["ulist*","ul"],
+    ["ulist-","ul"],
+    ["nlist", "ol"],
+    ["verbatim","pre"]]
+
+
+  def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+    s_prev = ""
+    ostr=[]
+    ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
+
+    intex = nil
+
+#
+# intex is used to suppress formatting. As you can see from the code below, 
+# suppression can take place only if "<tex>" appears as single item in one 
+# line, and suppression stops only of "</tex>" appears as single item in one
+# line. So if you use them in a more complex ways, it might cause strange 
+# problems.
+#
+    while s=instring.shift
+      header_candidate =s.split[0] 
+      new_item = nil
+      new_type = 1
+      if @@intex_state == 1
+	new_type = type
+	new_indet = indent
+	s1 = s
+      elsif (/^(\*|\-|\d+\.)$/ =~ header_candidate) 
+	new_type = 1+[/\*/,/\-/,/\d+\./].collect{
+	  |x| x=~ header_candidate}.index(0)
+
+	s1 = s.sub(/\S+\s/){|x| " "*x.length} 
+	new_indent = /\S/ =~ s1
+	new_item = 1
+      else
+	new_indent = /\S/ =~ s
+	new_indent = indent if /^\s*$/ =~s 
+	s1=s
+      end
+      if type == 4 and /^\s+/ =~s 
+	s1 = s
+	new_type=4
+	new_item = nil
+      end
+      if new_indent > indent and new_item == nil
+	new_type = 4 
+      end
+      s1= process_tex_special_chars(s1) unless new_type == 4
+      if new_indent > indent
+	instring.unshift(s)
+	new=1
+	new = nil if new_type == type and type == 4 
+	vlimit = indent+1 if new and new_type == 4
+	if new 
+	  ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+						     new_type,new,
+						     vlimit)
+	else
+	  ostr.push s1
+	  instring.shift
+	end
+      elsif new_indent == indent
+	if new_item
+	  if new_type != type
+	    ostr.push("</"+@@listtypes[type][1]+">")
+	    instring.unshift(s)
+	    ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+						       new_type,1,vlimit)
+	  end
+	  ostr.push("<li> ") if new_type < 4
+	end
+	ostr.push s1
+      else
+	if type == 4 and new_type==4 and new_indent > vlimit
+	  indent = new_indent
+	  ostr.push s1
+	else
+	  ostr.push("</"+@@listtypes[type][1]+">")
+	  instring.unshift(s)
+	  return ostr
+	end
+      end
+      s_prev = s
+    end	
+    ostr
+  end
+
+
   def setreuseoutput(value)
     @@reuseoutput = value
   end
@@ -1224,6 +1316,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
+      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1394.
Fri Nov 18 11:22:38 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1394)
+++ acsdoc2.rb	(working copy)
@@ -580,6 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+    instring = instring.split("\n")
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
@@ -658,7 +659,7 @@
       end
       s_prev = s
     end	
-    ostr
+    ostr.join("\n")
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1395.
Fri Nov 18 11:24:03 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1395)
+++ acsdoc2.rb	(working copy)
@@ -580,7 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
-    instring = instring.split("\n")
+    p instring
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1396.
Fri Nov 18 11:35:08 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1396)
+++ acsdoc2.rb	(working copy)
@@ -580,7 +580,7 @@
 
 
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
-    p instring
+    instring = instring.split("\n") if instring.class != Array
     s_prev = ""
     ostr=[]
     ostr.push("<"+@@listtypes[type][1]+">")  if new and (type >0)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1397.

    s=post_process_verbatim(s)

Do something if the previous line is blank? Seems unnecessary?

    s=process_link(s)

Fri Nov 18 11:48:19 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1397)
+++ acsdoc2.rb	(working copy)
@@ -571,6 +571,23 @@
 
   @@section_counters=[]
 
+  def process_link(instring)
+    instring = instring.split("\n") if instring.class != Array
+    ostring=[] 
+    while s=instring.shift
+      if /(^|\s)link\:(\S+)/  =~ s
+	imglinkfile = $2
+	s.sub!(/(^|\s)link\:(\S+)/,
+	       "\n<IMG src=#{imglinkfile}>\n")
+	@@imglinkcount+=1
+      end
+      ostring.push(s)
+    end
+    ostring
+  end
+
+
+
   @@listtypes=[
     ["paragraph","p"],
     ["ulist*","ul"],
@@ -1318,6 +1335,7 @@
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
       tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2= process_link(tmp2)
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1398.
Fri Nov 18 11:52:58 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1398)
+++ acsdoc2.rb	(working copy)
@@ -1313,11 +1313,7 @@
       instring.push(s)
     end
     ifile.close
-    unless tolatex_flag
-      s = convert_link_to_rdoc_style(instring,dirname)
-    else
-      s = instring
-    end
+    s = instring
     tmpstring=prep_cp_string(s,dirname,infile).split("\n");
     if tolatex_flag
       tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1399.

link: directly converted to IMG tag.



    s=process_wordmarkup(s,dirname)

Fri Nov 18 12:02:31 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1399)
+++ acsdoc2.rb	(working copy)
@@ -570,7 +570,38 @@
   @@section_label_table={}
 
   @@section_counters=[]
+  @@wordreplace=[
+    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"{\\tt", "}"],
+    [/(^|\W)\*(\w+)\*($|\W)/,"{\\bf", "}"],
+    [/(^|\W)\\_(\w+)\\_($|\W)/,"{\\it", "}"]
+  ]
+  
+  @@tagreplace=[
+    ["<tt>","</tt>","{\\tt", "}"],
+    ["<b>","</b>","{\\bf", "}"],
+    ["<em>","</em>","{\\it", "}"],
+    ["<i>","</i>","{\\it", "}"],
+    ["<tex>","</tex>","", ""]
+  ]
+  
 
+  def wordmarkup(instr)
+    @@wordreplace.each do |x| instr.gsub!(x[0]) do |word|
+	$1 + x[1]+ " " + $2 +x[2] + $3
+      end
+    end
+    instr
+  end
+
+  def process_wordmarkup(instring)
+    instring = instring.split("\n") if instring.class != Array
+    ostring = []
+    instring.each{|s| ostring.push(wordmarkup(s))}
+    ostring.join("\n")
+  end
+
+
+
   def process_link(instring)
     instring = instring.split("\n") if instring.class != Array
     ostring=[] 
@@ -583,7 +614,7 @@
       end
       ostring.push(s)
     end
-    ostring
+    ostring.join("\n")
   end
 
 
@@ -1332,6 +1363,8 @@
       tmp2= process_some_special_characters(tmp2)
       tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
+      tmp2=process_wordmarkup(tmp2)
+
     end
     ofile.print tmp2
     ofile.close
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1401.
Fri Nov 18 12:05:20 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1401)
+++ acsdoc2.rb	(working copy)
@@ -571,9 +571,9 @@
 
   @@section_counters=[]
   @@wordreplace=[
-    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"{\\tt", "}"],
-    [/(^|\W)\*(\w+)\*($|\W)/,"{\\bf", "}"],
-    [/(^|\W)\\_(\w+)\\_($|\W)/,"{\\it", "}"]
+    [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"<tt>", "</tt>"],
+    [/(^|\W)\*(\w+)\*($|\W)/,"<b>", "</b>"],
+    [/(^|\W)\\_(\w+)\\_($|\W)/,"<i>", "</i>"]
   ]
   
   @@tagreplace=[
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1402.

wordmarkup added.

    s=process_headers(s)   : already done
    s=process_refmarkup(s) : already done
    s=process_toc_latex(s) : already done
    s=process_ctrls(s)     : already done
    s = process_tagmarkup(s,dirname).join("\n") ???
    s= <<-END_TEXSOURCE
    #{@@basic_preambles_for_tex}
    #{@@additional_preambles_for_tex}
    \\begin{document}
       #{@@additional_commands_for_tex}
       #{s}
    \\end{document}
    END_TEXSOURCE
Fri Nov 18 12:15:19 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1403)
+++ acsdoc2.rb	(working copy)
@@ -1271,7 +1271,8 @@
 	@@tex_labels[labeltext]=lastsectionnumber
         @@tex_labels_filename[labeltext]=$current_cp_filename
 	print "Label #{labeltext} as #{lastsectionnumber}\n"
-
+      elsif /^---*$/ =~ str
+        ostring += "\n<hr>\n"
       else
 	x=str.gsub(/^(=+)\s*(.+)$/){|s| 
 	  sectionlevel = $1.length
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1404.

tried to change --- to hr

BUGS:

Link to figure is not quite right.

Fri Nov 18 12:29:51 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1404)
+++ acsdoc2.rb	(working copy)
@@ -1164,7 +1164,7 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"filename_to_link\"></p>"+
+    "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"#{filename_to_link}\"></p>"+
     "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1405.

Single change (hopefully...) correct figure. Not quite. since _ is
converted to \_ somewhere...

Something is wrong after processing figure.

File name becomes broken in process_single ...

Fri Nov 18 12:48:59 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1405)
+++ acsdoc2.rb	(working copy)
@@ -445,7 +445,6 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
-      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -1362,7 +1361,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+#      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1406.
Fri Nov 18 12:49:31 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1406)
+++ acsdoc2.rb	(working copy)
@@ -445,6 +445,7 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
+      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -669,7 +670,6 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
-      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1407.
Fri Nov 18 13:25:36 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1408)
+++ acsdoc2.rb	(working copy)
@@ -627,6 +627,9 @@
     ["verbatim","pre"]]
 
 
+  def process_tex_specials(s)
+    s.gsub(/\\<tex>/,"&lt;tex>").gsub(/<\/tex>/,"&lt;/tex>")
+  end
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
     instring = instring.split("\n") if instring.class != Array
     s_prev = ""
@@ -670,6 +673,7 @@
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
+      s1= process_tex_specials(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -1361,7 +1365,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-#      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1409.

added process_tex_specials which just takes care of \<tex> and
remaining </tex>.

Fri Nov 18 13:28:17 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1409)
+++ acsdoc2.rb	(working copy)
@@ -1225,7 +1225,7 @@
         reallabel = $2
         filename, tag=getauxlabel(dirname,reallabel)
         if filename
-          "<a href=#{filename}\##{reallabel}>#{tag}>"
+          "<a href=#{filename}\##{reallabel}>#{tag}</a>"
         else
           "(unknown label #{label})"
         end
@@ -1233,13 +1233,13 @@
 #        "("+@@tex_labels[label].to_s+")["+
 #          to_rdocname(@@tex_labels_filename[label])+"\#"+label+"]"
           "<a href="+to_htmlname(@@tex_labels_filename[label])+"\#"+label+">"+
-          @@tex_labels[label].to_s+">"
+          @@tex_labels[label].to_s+"</a>"
       elsif @@old_tex_labels[label]
 #          "("+@@old_tex_labels[label].to_s+")["+
 #            
           "<a href="+
              to_htmlname(@@old_tex_labels_filename[label])+"\#"+label+">"+
-          @@old_tex_labels[label].to_s+">"
+          @@old_tex_labels[label].to_s+"</a>"
       else
         "(unknown label #{label})"
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1410.

Equation tag was closed wrong. Fixed.

Name tag for equation is not processed correctly.

Fri Nov 18 13:31:45 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1410)
+++ acsdoc2.rb	(working copy)
@@ -1076,7 +1076,7 @@
       if s =~ /\\label\{(\S+)\}/ 
 	@@tex_labels[$1]=@@tex_equation_number
         @@tex_labels_filename[$1]=$current_cp_filename
-	namelabel = "<name>" + $1 + "</name>\n"
+	namelabel = "<a name=" + $1 + ">\n"
       end
       texcode += s + "\n"
       if s == nil 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1411.
Fri Nov 18 13:40:55 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1411)
+++ acsdoc2.rb	(working copy)
@@ -1022,7 +1022,7 @@
       raise "Failed to create the jpeg file #{texbase}.jpeg"
     end
     @@imgcount+=1
-    "<IMG SRC=#{imgname}>"
+    "<IMG ALIGN=\"middle\" SRC=#{imgname}>"
   end
 
   def process_tex_inlines(s,instring,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1412.

Equation should be a paragraph.

Fri Nov 18 13:43:24 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1412)
+++ acsdoc2.rb	(working copy)
@@ -1085,7 +1085,7 @@
     end
     texcode += "\\end{#{eqtype}}\n"
     pp = process_texcode(texcode,dirname)
-    namelabel = namelabel + pp+"\n\n"
+    namelabel +"<p>\n" pp+"</p>\n"
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1413.
Fri Nov 18 13:43:48 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1413)
+++ acsdoc2.rb	(working copy)
@@ -1085,7 +1085,7 @@
     end
     texcode += "\\end{#{eqtype}}\n"
     pp = process_texcode(texcode,dirname)
-    namelabel +"<p>\n" pp+"</p>\n"
+    namelabel +"<p>\n" +pp+"</p>\n"
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1414.

Double newline in plain paragraph mode is not converted to <p></p>
pair correctly.

Sat Nov 19 04:07:15 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1416.

The conversion should be taken care in

      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
Sat Nov 19 04:21:00 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1416)
+++ acsdoc2.rb	(working copy)
@@ -648,7 +648,7 @@
     while s=instring.shift
       header_candidate =s.split[0] 
       new_item = nil
-      new_type = 1
+      new_type = 0
       if @@intex_state == 1
 	new_type = type
 	new_indet = indent
@@ -697,6 +697,7 @@
 	  end
 	  ostr.push("<li> ") if new_type < 4
 	end
+        ostr.push "<p>\n" if new_type == 0 and type==0 and s_prev == ""
 	ostr.push s1
       else
 	if type == 4 and new_type==4 and new_indent > vlimit
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1417.

This change actually resulted in correct <p>.

Remaining things to do:

a) Adding navigation
b) add table of contents
c) Adding some style files

Maybe in this order?

Adding navigation is done in

create_navigations_for_cp_files(ARGV)
Sat Nov 19 04:39:15 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1417)
+++ acsdoc2.rb	(working copy)
@@ -1634,24 +1634,7 @@
   def add_links(filename,prev,nex)
     navi = navigation_string(prev,nex,filename)
     instring = open(filename,"r"){|f| f.gets(nil)}.split("\n")
-    ostring=""
-    while s = instring.shift
-      if s =~ /^<body(.)*>/
-	ostring += s + "\n" + navi+ "\n"
-      elsif s =~ /^<\/body/
-	ostring +=   navi + "\n" + s + "\n"
-      elsif  s =~ /<!-- banner header -->/
-        # adding space after header table
-	ostring +=    s + "\n <p>&ensp;</p> \n"
-      elsif s =~ /^<table.*Information on file/
-	# skip the filename block created by rdoc
-	while s !~ /^<\/table>/
-	  s= instring.shift
-	end
-      else
-	ostring +=     s + "\n"
-      end
-    end
+    ostring= navi+ "\n" +instring +navi+ "\n" 
     open(filename,"w"){|f| f.puts(ostring)}
   end
   def add_navigation_links(rdochtmls)
@@ -1666,12 +1649,12 @@
       add_links(rdochtmls[i],prev,nex)
     }
   end
-  def convert_cpfilename_to_rdoc_htmlfilename(name)
-    'doc/files/'+name.gsub(/\./, '_')+ '.html'
+  def convert_cpfilename_to_htmlfilename(name)
+    to_htmlname(name)
   end
   def create_navigations_for_cp_files(args)
     cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
-    cpfiles.collect!{|x|convert_cpfilename_to_rdoc_htmlfilename(x)}
+    cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
     add_navigation_links(cpfiles)
   end
 
@@ -1704,7 +1687,7 @@
   def add_toc
     @@filefortoc.collect!{|x|
       s=create_toc_string(x)
-      fname=convert_cpfilename_to_rdoc_htmlfilename(File.dirname(x)+
+      fname=convert_cpfilename_to_htmlfilename(File.dirname(x)+
 						    "/."+File.basename(x))
       instring=File.open(fname,"r").read.gsub(/TOCTOCTOCTOC/,s)
       f=File.open(fname,"w+")
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1418.
Sat Nov 19 04:40:27 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1418)
+++ acsdoc2.rb	(working copy)
@@ -1829,6 +1829,6 @@
    dump_aux
 end
 
-#create_navigations_for_cp_files(ARGV)
+create_navigations_for_cp_files(ARGV)
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1419.
Sat Nov 19 04:42:35 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1419)
+++ acsdoc2.rb	(working copy)
@@ -1638,6 +1638,7 @@
     open(filename,"w"){|f| f.puts(ostring)}
   end
   def add_navigation_links(rdochtmls)
+    print "Enter add navigation for #{rdochtmls}\n"
     n=rdochtmls.size
     rdochtmls.each_index{|i|
       if i == 0 then
@@ -1653,6 +1654,7 @@
     to_htmlname(name)
   end
   def create_navigations_for_cp_files(args)
+    print "Enter navigation\n"
     cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
     cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
     add_navigation_links(cpfiles)
@@ -1828,7 +1830,6 @@
 #  process_css
    dump_aux
 end
-
 create_navigations_for_cp_files(ARGV)
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1420.
Sat Nov 19 04:44:49 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1420)
+++ acsdoc2.rb	(working copy)
@@ -1651,7 +1651,7 @@
     }
   end
   def convert_cpfilename_to_htmlfilename(name)
-    to_htmlname(name)
+    name.gsub(/\.((cp)|(ok))$/,".html)
   end
   def create_navigations_for_cp_files(args)
     print "Enter navigation\n"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1421.
Sat Nov 19 04:45:12 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1421)
+++ acsdoc2.rb	(working copy)
@@ -1651,7 +1651,7 @@
     }
   end
   def convert_cpfilename_to_htmlfilename(name)
-    name.gsub(/\.((cp)|(ok))$/,".html)
+    name.gsub(/\.((cp)|(ok))$/,".html")
   end
   def create_navigations_for_cp_files(args)
     print "Enter navigation\n"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1422.
Sat Nov 19 04:56:05 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1422)
+++ acsdoc2.rb	(working copy)
@@ -1656,7 +1656,7 @@
   def create_navigations_for_cp_files(args)
     print "Enter navigation\n"
     cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
-    cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
+    cpfiles.collect!{|x|p x; convert_cpfilename_to_htmlfilename(x)}
     add_navigation_links(cpfiles)
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1423.
Sat Nov 19 04:56:58 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1423)
+++ acsdoc2.rb	(working copy)
@@ -1656,7 +1656,9 @@
   def create_navigations_for_cp_files(args)
     print "Enter navigation\n"
     cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
-    cpfiles.collect!{|x|p x; convert_cpfilename_to_htmlfilename(x)}
+    p cpfiles
+    cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
+    p cpfiles
     add_navigation_links(cpfiles)
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1424.
Sat Nov 19 04:58:13 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1424)
+++ acsdoc2.rb	(working copy)
@@ -1655,6 +1655,7 @@
   end
   def create_navigations_for_cp_files(args)
     print "Enter navigation\n"
+    p args
     cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
     p cpfiles
     cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1425.
Sat Nov 19 05:00:22 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1425)
+++ acsdoc2.rb	(working copy)
@@ -1654,13 +1654,7 @@
     name.gsub(/\.((cp)|(ok))$/,".html")
   end
   def create_navigations_for_cp_files(args)
-    print "Enter navigation\n"
-    p args
-    cpfiles = args.select{|x| x =~/\.((cp)|(ok))$/}
-    p cpfiles
-    cpfiles.collect!{|x|convert_cpfilename_to_htmlfilename(x)}
-    p cpfiles
-    add_navigation_links(cpfiles)
+    add_navigation_links(args)
   end
 
   
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1426.

file names are already html. So no conversion necessary.

Sat Nov 19 05:02:39 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1426)
+++ acsdoc2.rb	(working copy)
@@ -1633,7 +1633,7 @@
 
   def add_links(filename,prev,nex)
     navi = navigation_string(prev,nex,filename)
-    instring = open(filename,"r"){|f| f.gets(nil)}.split("\n")
+    instring = open(filename,"r"){|f| f.gets(nil)}
     ostring= navi+ "\n" +instring +navi+ "\n" 
     open(filename,"w"){|f| f.puts(ostring)}
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1427.

Navigation links created, but not quite correct.

Sat Nov 19 05:07:29 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1427)
+++ acsdoc2.rb	(working copy)
@@ -1602,17 +1602,16 @@
   
 @@toppagefilename= nil
   def navigation_string(prev,nex,filename)
-    uppath = "../"* File.dirname(filename).split('/').size
     prevtext = "Previous"
     nexttext = "Next"
     toctext  = "ToC"
     toptext  = ""
     if @@toppagefilename
-      toptext = "<td> \n   <a href=#{uppath+@@toppagefilename} target=\"_top\">Up</a>\n   </td>"
+      toptext = "<td> \n   <a href=#{@@toppagefilename} target=\"_top\">Up</a>\n   </td>"
     end
-    prevtext = "<a href=#{uppath+prev}>Previous</a>" if prev    
-    nexttext = "<a href=#{uppath+nex}>Next</a>" if nex
-    toctext = "<a href=#{uppath+@@filefortoc[0]}#TOC>ToC</a>" if @@filefortoc[0]
+    prevtext = "<a href=#{prev}>Previous</a>" if prev    
+    nexttext = "<a href=#{nex}>Next</a>" if nex
+    toctext = "<a href=#{@@filefortoc[0]}#TOC>ToC</a>" if @@filefortoc[0]
     s = <<END
 <table border="0" width="70%">
 <tr>
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1428.

Now navigation links are okay.


b) add table of contents
c) Adding some style files

Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1429.

Now table of contents.Sat Nov 19 05:11:04 JST 2005
Sat Nov 19 05:19:17 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1429)
+++ acsdoc2.rb	(working copy)
@@ -1685,8 +1685,7 @@
   def add_toc
     @@filefortoc.collect!{|x|
       s=create_toc_string(x)
-      fname=convert_cpfilename_to_htmlfilename(File.dirname(x)+
-						    "/."+File.basename(x))
+      fname=convert_cpfilename_to_htmlfilename(x)
       instring=File.open(fname,"r").read.gsub(/TOCTOCTOCTOC/,s)
       f=File.open(fname,"w+")
       f.write(instring)
@@ -1822,7 +1821,7 @@
 end
 
 unless tolatex_flag
-#  add_toc
+  add_toc
 #  process_css
    dump_aux
 end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1430.

toc is made, but its content is wrong.

Sat Nov 19 05:21:59 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1430)
+++ acsdoc2.rb	(working copy)
@@ -1661,7 +1661,7 @@
     s = "<p><H1>Contents</H1><a name=TOC><p>"
     currentlevel=0
     dirlevel=File.dirname(filename).split('/').size
-
+    p @@sectionheaders
     uppath = "../"*dirlevel
     @@sectionheaders.each{|x|
       while x[1]>currentlevel
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1431.
Sat Nov 19 05:23:32 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1431)
+++ acsdoc2.rb	(working copy)
@@ -1660,9 +1660,6 @@
   def create_toc_string(filename)
     s = "<p><H1>Contents</H1><a name=TOC><p>"
     currentlevel=0
-    dirlevel=File.dirname(filename).split('/').size
-    p @@sectionheaders
-    uppath = "../"*dirlevel
     @@sectionheaders.each{|x|
       while x[1]>currentlevel
 	s += "<ul>\n"
@@ -1672,8 +1669,7 @@
 	s+=  "</ul>\n"
 	currentlevel -= 1
       end
-      basename =File.dirname(x[3])+"/."+File.basename(x[3]) 
-      fname =     uppath+basename.gsub(/\./, '_')+ '.html'
+      fname =  convert_cpfilename_to_htmlfilename(x[3])
       s+= "<li> <a href=#{fname}##{x[0]}>#{x[2]}</a></li>\n"
     }
     while 0<currentlevel
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1432.
Sat Nov 19 05:32:06 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1432)
+++ acsdoc2.rb	(working copy)
@@ -1636,6 +1636,22 @@
     ostring= navi+ "\n" +instring +navi+ "\n" 
     open(filename,"w"){|f| f.puts(ostring)}
   end
+
+@@htmlheader = <<-END
+
+END
+
+@@htmlfooter = <<-END
+
+END
+
+  def add_html_headeretc(filenames)
+    filenames.each{|filename|
+      instring = open(filename,"r"){|f| f.gets(nil)}
+      ostring= @@htmlheader+ "\n" +instring +@@htmlfooter+ "\n" 
+      open(filename,"w"){|f| f.puts(ostring)}
+    }
+  end
   def add_navigation_links(rdochtmls)
     print "Enter add navigation for #{rdochtmls}\n"
     n=rdochtmls.size
@@ -1820,7 +1836,8 @@
   add_toc
 #  process_css
    dump_aux
+  create_navigations_for_cp_files(ARGV)
+  add_html_headeretc(ARGV)
 end
-create_navigations_for_cp_files(ARGV)
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1433.
Sat Nov 19 05:35:12 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1433)
+++ acsdoc2.rb	(working copy)
@@ -1638,11 +1638,20 @@
   end
 
 @@htmlheader = <<-END
+<html>
+<head>
+  <title>File: .ch01.ok</title>
+  <link rel=StyleSheet href=".acsdoc-style.css" type="text/css" media="screen" />
+</head>
 
+<body bgcolor="white">
+
 END
 
 @@htmlfooter = <<-END
 
+</body>
+</html>
 END
 
   def add_html_headeretc(filenames)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1434.
Sat Nov 19 05:39:54 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1434)
+++ acsdoc2.rb	(working copy)
@@ -1641,7 +1641,7 @@
 <html>
 <head>
   <title>File: .ch01.ok</title>
-  <link rel=StyleSheet href=".acsdoc-style.css" type="text/css" media="screen" />
+  <link rel=StyleSheet href="#{@@stylefilename}" type="text/css" media="screen" />
 </head>
 
 <body bgcolor="white">
@@ -1653,7 +1653,109 @@
 </body>
 </html>
 END
+@@htmlcss = <<-END
 
+
+body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
+       color: #000040;
+}
+
+.attr-rw { font-size: x-small; color: #444488 }
+
+.title-row { background: #0000aa;
+             color:      #eeeeff;
+}
+
+.big-title-font { color: white;
+                  font-family: Verdana, Arial, Helvetica, sans-serif;
+                  font-size: large; 
+                  height: 50px}
+
+.small-title-font { color: aqua;
+                    font-family: Verdana, Arial, Helvetica, sans-serif;
+                    font-size: xx-small; }
+
+.aqua { color: aqua }
+
+.method-name, attr-name {
+      font-family: monospace; font-weight: bold;
+}
+
+.tablesubtitle, .tablesubsubtitle {
+   width: 100%;
+   margin-top: 1ex;
+   margin-bottom: .5ex;
+   padding: 5px 0px 5px 20px;
+   font-size: large;
+   color: aqua;
+   background: #3333cc;
+}
+
+.name-list {
+  font-family: monospace;
+  margin-left: 40px;
+  margin-bottom: 2ex;
+  line-height: 140%;
+}
+
+.description {
+  margin-left: 40px;
+  margin-top: -2ex;
+  margin-bottom: 2ex;
+}
+
+.description p {
+  line-height: 140%;
+}
+
+.aka {
+  margin-left: 40px;
+  margin-bottom: 2ex;
+  line-height: 100%;
+  font-size:   small;
+  color:       #808080;
+}
+
+.methodtitle {
+  font-size: medium;
+  text-decoration: none;
+  color: #0000AA;
+  background: white; 
+}
+
+.paramsig {
+   font-size: small;
+}
+
+.srcbut { float: right }
+
+
+pre.source {
+  border-style: groove;
+  background-color: #ddddff;
+  margin-left:  40px;
+  padding: 1em 0em 1em 2em;
+}
+
+.classlist {
+  margin-left: 40px;
+  margin-bottom: 2ex;
+  line-height: 140%;
+}
+
+li {
+  display:    list-item;
+  margin-top: .6em;
+}
+
+.kw { color: #3333FF; font-weight: bold }
+.cmt { color: green; font-style: italic }
+.str { color: #662222; font-style: italic }
+.re  { color: #662222; }
+END
+
+@@stylefilename = ".acsdoc-style.css"
+
   def add_html_headeretc(filenames)
     filenames.each{|filename|
       instring = open(filename,"r"){|f| f.gets(nil)}
@@ -1716,20 +1818,7 @@
   end
 
   def process_css
-    cssbackupfilename = "doc/rdoc-style.css.orig"
-    cssfilename = "doc/rdoc-style.css"
-    File.rename(cssfilename,cssbackupfilename)
-    f=open(cssbackupfilename,"r")
-    fout=open(cssfilename,"w")
-    while s=f.gets
-      if s =~ /^\s*(pre|tt)\s*\{.*\}/
-	print "line #{s} removed from CSS file"
-      else
-	fout.print s
-      end
-    end
-    f.close
-    fout.close
+    open(@@stylefilename"w"){|x| x.write @@htmlcss}
   end
 
   def dump_aux
@@ -1843,8 +1932,8 @@
 
 unless tolatex_flag
   add_toc
-#  process_css
-   dump_aux
+  process_css
+  dump_aux
   create_navigations_for_cp_files(ARGV)
   add_html_headeretc(ARGV)
 end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1435.
Sat Nov 19 05:40:31 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1435)
+++ acsdoc2.rb	(working copy)
@@ -1818,7 +1818,7 @@
   end
 
   def process_css
-    open(@@stylefilename"w"){|x| x.write @@htmlcss}
+    open(@@stylefilename,"w"){|x| x.write @@htmlcss}
   end
 
   def dump_aux
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1436.
Sat Nov 19 05:42:44 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1436)
+++ acsdoc2.rb	(working copy)
@@ -488,7 +488,7 @@
   def post_process_verbatim(instring)
     ostr=[]
     while s=instring.shift
-      if s =~ /\\end\{verbatim}/
+      if s =~ /\\end\{verbatim\}/
 	unless (last = ostr.pop) =~ /^\s*$/
 	  ostr.push last
 	end
@@ -1637,6 +1637,8 @@
     open(filename,"w"){|f| f.puts(ostring)}
   end
 
+@@stylefilename = ".acsdoc-style.css"
+
 @@htmlheader = <<-END
 <html>
 <head>
@@ -1754,7 +1756,6 @@
 .re  { color: #662222; }
 END
 
-@@stylefilename = ".acsdoc-style.css"
 
   def add_html_headeretc(filenames)
     filenames.each{|filename|
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1437.
Sat Nov 19 05:45:26 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1437)
+++ acsdoc2.rb	(working copy)
@@ -1657,7 +1657,11 @@
 END
 @@htmlcss = <<-END
 
+PRE {
+  background: #D0FFE0;
 
+}
+
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000040;
 }
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1438.
Sat Nov 19 05:47:06 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1439.
Sat Nov 19 05:52:56 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1439)
+++ acsdoc2.rb	(working copy)
@@ -1663,7 +1663,7 @@
 }
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
-       color: #000040;
+       color: #000010;
 }
 
 .attr-rw { font-size: x-small; color: #444488 }
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1440.
Sat Nov 19 05:53:16 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1440)
+++ acsdoc2.rb	(working copy)
@@ -1658,7 +1658,7 @@
 @@htmlcss = <<-END
 
 PRE {
-  background: #D0FFE0;
+  background: #E0FFE8;
 
 }
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1441.
Sat Nov 19 06:14:42 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1441)
+++ acsdoc2.rb	(working copy)
@@ -1769,7 +1769,6 @@
     }
   end
   def add_navigation_links(rdochtmls)
-    print "Enter add navigation for #{rdochtmls}\n"
     n=rdochtmls.size
     rdochtmls.each_index{|i|
       if i == 0 then
@@ -1890,9 +1889,9 @@
       end
       $current_cp_filename = a
       prep_cp(a, dot_a, tolatex_flag)
-      a = dot_a
+      a = File.exist?(dot_a) ? dot_a : nil
     else
-      a = ""
+      a = nil
     end
     a
   elsif a =~ /\.rb$/
@@ -1914,18 +1913,18 @@
 #      prep_rb_special_comments(a)
 #      prep_rb_special_comments_for_partfiles(a)
     else
-      a = ""
+      a = nil
     end
     a
   elsif a == "--tolatex"
     tolatex_flag = true
     del_flag = false
-    a = ""
+    a = nil
   elsif a == "--reuseoutput"
     print "reuse flag set\n"
     setreuseoutput true
     readin_commandoutputs
-    a = ""
+    a = nil
   end
   a
 end
@@ -1935,6 +1934,8 @@
   coptions = " "
 end
 
+ARGV.compact!
+
 unless tolatex_flag
   add_toc
   process_css
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1442.

html headers and footers added, zero-length files (html files not
made) are removed from the file list for postprocessing

a) Remaining problem: What to do with the old file location?

Old file is: doc/files/_/_ch01_ok.html


b) Should I support the multiple independent documents in one
   directory?

First things first.

Sat Nov 19 06:58:33 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1442)
+++ acsdoc2.rb	(working copy)
@@ -1862,6 +1862,12 @@
     end 
     $volindex = @@volindex
   end
+
+
+  def convert_cpfilename_to_rdoc_htmlfilename(name)
+    name = File.dirname(name)+"/."+File.basename(name)
+    'doc/files/'+name.gsub(/\./, '_')+ '.html'
+  end
 end
 
 
@@ -1877,6 +1883,7 @@
 del_flag = true
 tolatex_flag = false
 
+cpfiles = []
 ARGV.collect! do |a|
   if a =~ /\.((cp)|(ok))$/
     extention = "."+$1
@@ -1889,7 +1896,12 @@
       end
       $current_cp_filename = a
       prep_cp(a, dot_a, tolatex_flag)
-      a = File.exist?(dot_a) ? dot_a : nil
+      if File.exist?(dot_a)
+        cpfiles.push([a,dot_a, convert_cpfilename_to_htmlfilename(a)])
+        a = dot_a
+      else
+        a = nil
+      end
     else
       a = nil
     end
@@ -1934,6 +1946,7 @@
   coptions = " "
 end
 
+p cpfiles
 ARGV.compact!
 
 unless tolatex_flag
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1443.
Sat Nov 19 06:59:51 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1443)
+++ acsdoc2.rb	(working copy)
@@ -1897,7 +1897,7 @@
       $current_cp_filename = a
       prep_cp(a, dot_a, tolatex_flag)
       if File.exist?(dot_a)
-        cpfiles.push([a,dot_a, convert_cpfilename_to_htmlfilename(a)])
+        cpfiles.push([a,dot_a, convert_cpfilename_to_rdoc_htmlfilename(a)])
         a = dot_a
       else
         a = nil
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1444.
Sat Nov 19 07:06:01 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1444)
+++ acsdoc2.rb	(working copy)
@@ -1868,9 +1868,22 @@
     name = File.dirname(name)+"/."+File.basename(name)
     'doc/files/'+name.gsub(/\./, '_')+ '.html'
   end
+
+  def make_notice_for_old_page(newfile, oldfile)
+    if File.exist?(oldfile)
+      open(oldfile,"w"){|f| f.write <<-END
+<HTML>        
+<BODY>
+          This page is moved to <a href="../../../#{newfile}">here</a>.<p>
+Please update your bookmarks.
+</BODY>
+</HTML>        
+END
+      }
 end
 
 
+
 # :segment start: acsdoc
 include Acsdoc
 
@@ -1955,6 +1968,7 @@
   dump_aux
   create_navigations_for_cp_files(ARGV)
   add_html_headeretc(ARGV)
+  cpfiles.each{|x| make_notice_for_old_page(x[1],x[2])}
 end
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1445.
Sat Nov 19 07:09:41 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1445)
+++ acsdoc2.rb	(working copy)
@@ -1573,7 +1573,7 @@
 	  functionstring += s
 	end
 	if $1
-	  while s !~ /^}/
+	  while s !~ /^\}/
 	    s = expand(ifile.gets)
 	    functionstring += s
 	  end
@@ -1872,14 +1872,16 @@
   def make_notice_for_old_page(newfile, oldfile)
     if File.exist?(oldfile)
       open(oldfile,"w"){|f| f.write <<-END
-<HTML>        
-<BODY>
-          This page is moved to <a href="../../../#{newfile}">here</a>.<p>
+        <HTML>        
+          <BODY>
+          This page has been moved to <a href="../../../#{newfile}">here</a>.<p>
 Please update your bookmarks.
 </BODY>
-</HTML>        
+          </HTML>        
 END
       }
+    end
+  end
 end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1446.
Sat Nov 19 07:12:36 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1447.

Sat Nov 19 10:21:02 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1447)
+++ acsdoc2.rb	(working copy)
@@ -751,7 +751,11 @@
     }    
   end
 
-
+  @@verbatim_separator = "---\n"
+  
+  def reset_verbatim_separator
+    @@verbatim_separator = ""
+  end
     
 #
 # takes a single string which contains a command
@@ -769,7 +773,7 @@
     tmpcommand = ".acsdoc.command-file"
     prompt = " "* indent + @@prompt
     commandline = a[1..a.size].join(" ").chomp
-    ostring = ostring +  "---\n"     unless ( noout or @previous_is_command )
+    ostring = ostring +  @@verbatim_separator     unless ( noout or @previous_is_command )
       fullcommand  = "cd #{dirname}; #{commandline}" 
     unless noout or nooutput
       fullcommand  = "cd #{dirname}; (#{commandline})>&  #{tmpname}" 
@@ -839,7 +843,7 @@
     tmpcommand = ".acsdoc.command-file"
     prompt = " "* indent + @@prompt
     commandline = a[1..a.size].join(" ").chomp
-    ostring = ostring +  "---\n"
+    ostring = ostring +  @@verbatim_separator
     fullcommand = "cd #{dirname}; (" +commandline+ "<" + tmpinname + " )"
     if showout
 #      fullcommand  +=   " >& " + tmpname 
@@ -859,7 +863,7 @@
     output = indata 
     output += `cat #{dirname}/#{tmpname}`  if  showout
     output.each{|x| ostring = ostring +  " "*indent + x}
-    ostring = ostring +  "---\n"
+    ostring = ostring +  @@verbatim_separator
     @previous_is_command = nil if showout 
     if showout then ostring else "" end
   end
@@ -935,9 +939,9 @@
       elsif s =~ /:in.*code:/ and s.index("\":inccode:\"")==nil
 	s.sub!(/:in.*code:/, ':include: ')
         raise "failed to open file #{s.split[1]}" unless file_is_there(s.split[1])
-	ostring = ostring +  "---\n"
+	ostring = ostring +  @@verbatim_separator
 	ostring = ostring +  s
-	ostring = ostring +  "---\n"
+	ostring = ostring +  @@verbatim_separator
       elsif loc = check_tag(s,":output:")
 	ostring = ostring +  add_output(s, dirname, ":output:",fname,lineno)
       elsif loc = s.index(":commandoutput:")  and s.index("\":commandoutput:\"")==nil
@@ -958,7 +962,7 @@
 	ostring = ostring +  command_with_input(s,":commandinput:", instring,
 				      dirname,false)
       else
-	ostring += "---\n" if @previous_is_command
+	ostring += @@verbatim_separator if @previous_is_command
 	ostring += s 
 	@previous_is_command = nil 
       end
@@ -1350,6 +1354,7 @@
     end
     ifile.close
     s = instring
+    reset_verbatim_separator    unless tolatex_flag
     tmpstring=prep_cp_string(s,dirname,infile).split("\n");
     if tolatex_flag
       tmp2= Rdoctotex::convert_to_latex(tmpstring,dirname);
@@ -1961,7 +1966,6 @@
   coptions = " "
 end
 
-p cpfiles
 ARGV.compact!
 
 unless tolatex_flag
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1448.

removed trailing blank lines after verbatim.

Sat Nov 19 11:26:13 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1448)
+++ acsdoc2.rb	(working copy)
@@ -670,6 +670,12 @@
 	new_type=4
 	new_item = nil
       end
+      if type == 4 and s=="" 
+	s1 = s
+	new_type=0
+        new_indent=0
+	new_item = nil
+      end
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
@@ -812,9 +818,10 @@
         end
         output.each{|x| ostring+=  " "*indent +x} 
       end
-      ostring+= "\n"
+      ostring= ostring.chomp+"\n"
       @previous_is_command = true;
     end
+    p ostring
     ostring
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Sending        documentation/ch03.ok
Transmitting file data ..

More fix for removing trailing blank lines.

Sat Nov 19 11:28:59 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1449)
+++ acsdoc2.rb	(working copy)
@@ -1179,8 +1179,9 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
+    "<div class="center">"+
     "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"#{filename_to_link}\"></p>"+
-    "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p>"
+    "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p></div>"
   end
 
 
@@ -1673,6 +1674,7 @@
   background: #E0FFE8;
 
 }
+.center  { text-align: center; }
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1450.
Sat Nov 19 11:29:23 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1450)
+++ acsdoc2.rb	(working copy)
@@ -1179,7 +1179,7 @@
       end
     end
     filename_to_link = copy_figure_file(figurefilename,dirname,@@figure_number)
-    "<div class="center">"+
+    "<div class=\"center\">"+
     "<p>"+namelabel + "<img ALIGN=\"middle\" src=\"#{filename_to_link}\"></p>"+
     "\n<p> Figure " + @@figure_number.to_s + ": " + caption + "</p></div>"
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1451.
Sat Nov 19 11:30:29 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1451)
+++ acsdoc2.rb	(working copy)
@@ -1097,7 +1097,7 @@
     end
     texcode += "\\end{#{eqtype}}\n"
     pp = process_texcode(texcode,dirname)
-    namelabel +"<p>\n" +pp+"</p>\n"
+    namelabel +"<div class=\"center\"><p>\n" +pp+"</p></div>\n"
   end
 
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1452.
Sat Nov 19 11:39:11 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1452)
+++ acsdoc2.rb	(working copy)
@@ -1097,7 +1097,7 @@
     end
     texcode += "\\end{#{eqtype}}\n"
     pp = process_texcode(texcode,dirname)
-    namelabel +"<div class=\"center\"><p>\n" +pp+"</p></div>\n"
+    namelabel +"<div class=\"equation\"><p>\n" +pp+"</p></div>\n"
   end
 
 
@@ -1676,6 +1676,8 @@
 }
 .center  { text-align: center; }
 
+.equation  { margine-left: auto;}
+
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
 }
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1453.
Sat Nov 19 11:40:09 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1453)
+++ acsdoc2.rb	(working copy)
@@ -1676,7 +1676,7 @@
 }
 .center  { text-align: center; }
 
-.equation  { margine-left: auto;}
+.equation  { margine-left: auto; margine-right: 3px;}
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1454.
Sat Nov 19 11:40:28 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1454)
+++ acsdoc2.rb	(working copy)
@@ -1676,7 +1676,7 @@
 }
 .center  { text-align: center; }
 
-.equation  { margine-left: auto; margine-right: 3px;}
+.equation  { margin-left: auto; margin-right: 3px;}
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1455.
Sat Nov 19 11:42:08 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1455)
+++ acsdoc2.rb	(working copy)
@@ -1676,7 +1676,7 @@
 }
 .center  { text-align: center; }
 
-.equation  { margin-left: auto; margin-right: 3px;}
+.equation  { margin-left: auto; margin-right: auto;}
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1456.
Sat Nov 19 11:44:45 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1456)
+++ acsdoc2.rb	(working copy)
@@ -1676,7 +1676,7 @@
 }
 .center  { text-align: center; }
 
-.equation  { margin-left: auto; margin-right: auto;}
+.equation  { text-align: right; }
 
 body,td,p { font-family: Verdana, Arial, Helvetica, sans-serif; 
        color: #000010;
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1457.
Sat Nov 19 12:55:59 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1457)
+++ acsdoc2.rb	(working copy)
@@ -1652,17 +1652,18 @@
 
 @@stylefilename = ".acsdoc-style.css"
 
-@@htmlheader = <<-END
+  def htmlheader(name)
+    <<-END
 <html>
 <head>
-  <title>File: .ch01.ok</title>
+  <title> #{name}</title>
   <link rel=StyleSheet href="#{@@stylefilename}" type="text/css" media="screen" />
 </head>
 
 <body bgcolor="white">
 
 END
-
+  end
 @@htmlfooter = <<-END
 
 </body>
@@ -1780,7 +1781,7 @@
   def add_html_headeretc(filenames)
     filenames.each{|filename|
       instring = open(filename,"r"){|f| f.gets(nil)}
-      ostring= @@htmlheader+ "\n" +instring +@@htmlfooter+ "\n" 
+      ostring= htmlheader(filename)+ "\n" +instring +@@htmlfooter+ "\n" 
       open(filename,"w"){|f| f.puts(ostring)}
     }
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1458.

Figures are centered, equations are right-alighned.

Sat Nov 19 13:22:15 JST 2005
Sending        documentation/acsdoc-rev-memo
Sending        documentation/ch03.ok
Transmitting file data .Sat Nov 19 13:23:33 JST 2005
Sending        documentation/acsdoc-rev-memo
Sending        documentation/ch03.ok
Transmitting file data .Sat Nov 19 13:27:13 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1460)
+++ acsdoc2.rb	(working copy)
@@ -573,7 +573,7 @@
   @@wordreplace=[
     [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"<tt>", "</tt>"],
     [/(^|\W)\*(\w+)\*($|\W)/,"<b>", "</b>"],
-    [/(^|\W)\\_(\w+)\\_($|\W)/,"<i>", "</i>"]
+    [/(^|\W)\_(\w+)\_($|\W)/,"<i>", "</i>"]
   ]
   
   @@tagreplace=[
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1461.

Italic on HTML now correctly shown.

Other things which need to be implemented

--- table
--- local directory

Better to start with local directory.

Sun Nov 20 01:26:58 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1461)
+++ acsdoc2.rb	(working copy)
@@ -1915,6 +1915,8 @@
 del_flag = true
 tolatex_flag = false
 
+diretory_arg  = false
+directory_name = nil
 cpfiles = []
 ARGV.collect! do |a|
   if a =~ /\.((cp)|(ok))$/
@@ -1946,7 +1948,7 @@
       prep_rb_special_comments(a)
       prep_rb_special_comments_for_partfiles(a)
     else
-      a = ""
+      a = nil
     end
     a
   elsif a =~ /\.(h|C|c|cc)$/
@@ -1969,6 +1971,13 @@
     setreuseoutput true
     readin_commandoutputs
     a = nil
+  elsif a == "--directory"
+    directory_arg = true        
+    a = nil
+  elsif directory_arg
+    directory_name = a
+    directory_arg = false
+    a=nil
   end
   a
 end
@@ -1989,4 +1998,12 @@
   cpfiles.each{|x| make_notice_for_old_page(x[1],x[2])}
 end
 
+if directory_name
+  if File.exist?(directory_name) and not File.directory?(directory_name)
+    raise "#{directory_name} is a file. Cannot move texts there"
+  end
+  Dir.mkdir(directory_name) unless File.exist?(directory_name)
+  system("mv #{ARGV} .imgs #{directory_name}"
+end
+
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1462.
Sun Nov 20 01:27:24 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1462)
+++ acsdoc2.rb	(working copy)
@@ -2003,7 +2003,7 @@
     raise "#{directory_name} is a file. Cannot move texts there"
   end
   Dir.mkdir(directory_name) unless File.exist?(directory_name)
-  system("mv #{ARGV} .imgs #{directory_name}"
+  system "mv #{ARGV} .imgs #{directory_name}"
 end
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1463.
Sun Nov 20 01:39:54 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1463)
+++ acsdoc2.rb	(working copy)
@@ -1915,10 +1915,12 @@
 del_flag = true
 tolatex_flag = false
 
-diretory_arg  = false
+directory_arg  = false
 directory_name = nil
 cpfiles = []
 ARGV.collect! do |a|
+  p a
+  p directory_arg
   if a =~ /\.((cp)|(ok))$/
     extention = "."+$1
     $current_extention=extention
@@ -1972,10 +1974,12 @@
     readin_commandoutputs
     a = nil
   elsif a == "--directory"
+    print "Directory arg found\n"
     directory_arg = true        
     a = nil
-  elsif directory_arg
-    directory_name = a
+  elsif directory_arg == true
+    directory_name = a 
+    print "Directory to store: #{a}\n"
     directory_arg = false
     a=nil
   end
@@ -2003,7 +2007,13 @@
     raise "#{directory_name} is a file. Cannot move texts there"
   end
   Dir.mkdir(directory_name) unless File.exist?(directory_name)
-  system "mv #{ARGV} .imgs #{directory_name}"
+  if  File.exist?(directory_name+"/.imgs")
+    files = Dir(directory_name+"/.imgs/*")
+    p files
+    File.delete(files) if files.size > 0
+    Dir.rmdir(directory_name+"/.imgs") 
+  end
+  system "mv -f  #{ARGV.join(" ")} .imgs #{directory_name}"
 end
 
 # :segment end:
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1464.
Sun Nov 20 01:40:30 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1464)
+++ acsdoc2.rb	(working copy)
@@ -2008,7 +2008,7 @@
   end
   Dir.mkdir(directory_name) unless File.exist?(directory_name)
   if  File.exist?(directory_name+"/.imgs")
-    files = Dir(directory_name+"/.imgs/*")
+    files = Dir.glob(directory_name+"/.imgs/*")
     p files
     File.delete(files) if files.size > 0
     Dir.rmdir(directory_name+"/.imgs") 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1465.
Sun Nov 20 01:41:05 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1465)
+++ acsdoc2.rb	(working copy)
@@ -2010,7 +2010,7 @@
   if  File.exist?(directory_name+"/.imgs")
     files = Dir.glob(directory_name+"/.imgs/*")
     p files
-    File.delete(files) if files.size > 0
+    File.delete(*files) if files.size > 0
     Dir.rmdir(directory_name+"/.imgs") 
   end
   system "mv -f  #{ARGV.join(" ")} .imgs #{directory_name}"
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1466.

Now --directory flag works.

Sun Nov 20 01:57:02 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1466)
+++ acsdoc2.rb	(working copy)
@@ -717,7 +717,7 @@
       end
       s_prev = s
     end	
-    ostr.join("\n")
+    ostr
   end
 
 
@@ -1379,7 +1379,7 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0).join("\n")
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
@@ -1919,8 +1919,6 @@
 directory_name = nil
 cpfiles = []
 ARGV.collect! do |a|
-  p a
-  p directory_arg
   if a =~ /\.((cp)|(ok))$/
     extention = "."+$1
     $current_extention=extention
@@ -2009,7 +2007,6 @@
   Dir.mkdir(directory_name) unless File.exist?(directory_name)
   if  File.exist?(directory_name+"/.imgs")
     files = Dir.glob(directory_name+"/.imgs/*")
-    p files
     File.delete(*files) if files.size > 0
     Dir.rmdir(directory_name+"/.imgs") 
   end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1467.

Bug for nested something... fixed hopefully.

Sun Nov 20 03:35:47 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1467)
+++ acsdoc2.rb	(working copy)
@@ -1962,12 +1962,15 @@
       a = nil
     end
     a
+  elsif a == "--keep-dot-files"
+    print "Obsolete option ignored:  --keep-dot-files\n"
+    a = nil
   elsif a == "--tolatex"
     tolatex_flag = true
     del_flag = false
     a = nil
   elsif a == "--reuseoutput"
-    print "reuse flag set\n"
+    print "reuse flag set\n" 
     setreuseoutput true
     readin_commandoutputs
     a = nil
@@ -1991,12 +1994,15 @@
 
 ARGV.compact!
 
+
 unless tolatex_flag
+  cplist = cpfiles.collect{|x| x[1]}
+  p cplist
   add_toc
   process_css
   dump_aux
-  create_navigations_for_cp_files(ARGV)
-  add_html_headeretc(ARGV)
+  create_navigations_for_cp_files(cplist)
+  add_html_headeretc(cplist)
   cpfiles.each{|x| make_notice_for_old_page(x[1],x[2])}
 end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc.rb
Sending        documentation/acsdoc2.rb
Sending        documentation/sample.rb
Transmitting file data ..

removed .rb or other files from args to HTML editing functions.

Sun Nov 20 03:52:20 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1468)
+++ acsdoc2.rb	(working copy)
@@ -19,13 +19,13 @@
 #$DEBUG=1
 module Rdoctotex
 
-  @@wordreplace=[
+  @@latexwordreplace=[
     [/(^|\W)\+([a-zA-Z_]+)\+($|\W)/,"{\\tt", "}"],
     [/(^|\W)\*(\w+)\*($|\W)/,"{\\bf", "}"],
     [/(^|\W)\\_(\w+)\\_($|\W)/,"{\\it", "}"]
   ]
   
-  @@tagreplace=[
+  @@latextagreplace=[
     ["<tt>","</tt>","{\\tt", "}"],
     ["<b>","</b>","{\\bf", "}"],
     ["<em>","</em>","{\\it", "}"],
@@ -37,7 +37,7 @@
     "part","chapter","section","subsection","subsubsection",
     "subsubsubsection"]
 
-  @@listtypes=[
+  @@latexlisttypes=[
     ["paragraph",""],
     ["ulist*","itemize"],
     ["ulist-","itemize"],
@@ -73,20 +73,20 @@
   end
   
   def wordmarkup(instr)
-    @@wordreplace.each do |x| instr.gsub!(x[0]) do |word|
+    @@latexwordreplace.each do |x| instr.gsub!(x[0]) do |word|
 	$1 + x[1]+ " " + $2 +x[2] + $3
       end
     end
     instr
   end
 
-  def process_wordmarkup(instring,dirname)
+  def latex_process_wordmarkup(instring,dirname)
     ostring = []
     instring.each{|s| ostring.push(wordmarkup(s))}
   end
 
   def tagmarkup(instr)
-    @@tagreplace.each do |x| 
+    @@latextagreplace.each do |x| 
       instr.gsub!(x[0]) { |word|x[2]+ " " }
       instr.gsub!(x[1]) { |word|x[3] }
     end
@@ -266,7 +266,7 @@
   @@latex_section_number = 0
   @@latex_section_table={}
   
-  def process_headers(instring)
+  def latex_process_headers(instring)
     
     nosectionnumber = nil
     
@@ -352,7 +352,7 @@
     ostring
   end
   
-  def process_link(instring)
+  def latex_process_link(instring)
     ostring=[] 
     while s=instring.shift
       if /(^|\s)link\:(\S+)/  =~ s
@@ -403,10 +403,10 @@
     ostring
   end
   
-  def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+  def latex_process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
     s_prev = ""
     ostr=[]
-    ostr.push("\\begin{"+@@listtypes[type][1]+"}")  if new and (type >0)
+    ostr.push("\\begin{"+@@latexlisttypes[type][1]+"}")  if new and (type >0)
 
     intex = nil
 
@@ -452,7 +452,7 @@
 	new = nil if new_type == type and type == 4 
 	vlimit = indent+1 if new and new_type == 4
 	if new 
-	  ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+	  ostr+= latex_process_single_paragraphs_lists_etc(instring,new_indent,
 						     new_type,new,
 						     vlimit)
 	else
@@ -462,9 +462,9 @@
       elsif new_indent == indent
 	if new_item
 	  if new_type != type
-	    ostr.push("\\end{"+@@listtypes[type][1]+"}")
+	    ostr.push("\\end{"+@@latexlisttypes[type][1]+"}")
 	    instring.unshift(s)
-	    ostr+= process_single_paragraphs_lists_etc(instring,new_indent,
+	    ostr+= latex_process_single_paragraphs_lists_etc(instring,new_indent,
 						       new_type,1,vlimit)
 	  end
 	  ostr.push("\\item ") if new_type < 4
@@ -475,7 +475,7 @@
 	  indent = new_indent
 	  ostr.push s1
 	else
-	  ostr.push("\\end{"+@@listtypes[type][1]+"}")
+	  ostr.push("\\end{"+@@latexlisttypes[type][1]+"}")
 	  instring.unshift(s)
 	  return ostr
 	end
@@ -528,11 +528,11 @@
     s=latex_process_tex_equations(s)
     s=latex_process_tex_weblinks(s)
     s=latex_find_and_process_figures(s,dirname)
-    s=process_single_paragraphs_lists_etc(s,0,0,1,0)
+    s=latex_process_single_paragraphs_lists_etc(s,0,0,1,0)
     s=post_process_verbatim(s)
-    s=process_link(s)
-    s=process_wordmarkup(s,dirname)
-    s=process_headers(s)
+    s=latex_process_link(s)
+    s=latex_process_wordmarkup(s,dirname)
+    s=latex_process_headers(s)
     s=process_refmarkup(s)
     s=process_toc_latex(s)
     s=process_ctrls(s)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc.rb
Sending        documentation/acsdoc2.rb
Transmitting file data ..

Confusion between function names and class variable names resolved

Sun Nov 20 04:02:41 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1469)
+++ acsdoc2.rb	(working copy)
@@ -72,7 +72,7 @@
     s
   end
   
-  def wordmarkup(instr)
+  def latexwordmarkup(instr)
     @@latexwordreplace.each do |x| instr.gsub!(x[0]) do |word|
 	$1 + x[1]+ " " + $2 +x[2] + $3
       end
@@ -82,7 +82,7 @@
 
   def latex_process_wordmarkup(instring,dirname)
     ostring = []
-    instring.each{|s| ostring.push(wordmarkup(s))}
+    instring.each{|s| ostring.push(latexwordmarkup(s))}
   end
 
   def tagmarkup(instr)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1470.

Still more confusion. Fixed (hopefully)

--tolatex version seems to make identical files with old acsdoc.rb

Sun Nov 20 04:23:50 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1470)
+++ acsdoc2.rb	(working copy)
@@ -1886,18 +1886,23 @@
     'doc/files/'+name.gsub(/\./, '_')+ '.html'
   end
 
+  def create_dir_recursively(name)
+    parent = File.dirname(name)
+    create_dir_recursively(parent) if not File.exist?(parent)
+    Dir.mkdir(name) if not File.exist?(name)
+  end
+
   def make_notice_for_old_page(newfile, oldfile)
-    if File.exist?(oldfile)
-      open(oldfile,"w"){|f| f.write <<-END
-        <HTML>        
-          <BODY>
-          This page has been moved to <a href="../../../#{newfile}">here</a>.<p>
+    create_dir_recursively(File.dirname(oldfile)) if not File.exist?(oldfile)
+    open(oldfile,"w"){|f| f.write <<-END
+      <HTML>        
+        <BODY>
+        This page has been moved to <a href="../../../#{newfile}">here</a>.<p>
 Please update your bookmarks.
 </BODY>
-          </HTML>        
+        </HTML>        
 END
       }
-    end
   end
 end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1471.

Added the capability to create "doc" directory always, even if it is
not there.

Sun Nov 20 04:47:56 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1472.

The following text:

\<web\>url|linktext\</web\>. For example,

Does not compiled correctly.

Sun Nov 20 07:26:20 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1474)
+++ acsdoc2.rb	(working copy)
@@ -1326,17 +1326,22 @@
   end
 
   def process_tex_weblinks(instring)
-    ostring=instring.gsub(/(\s)<web>(.+?)<\/web>/m){ linktext = $2
+    ostring=instring.gsub(/(\s)(\\)<web>(.+?)<\/web>/m){ linktext = $3
       blank=$1
       p linktext  if $DEBUG
-      if linktext =~ /(.*)\|(.*)/m
-	url=($1)
-	text=$2
+      if $2 != ""
+        if linktext =~ /(.*)\|(.*)/m
+          url=($1)
+          text=$2
+        else
+          url=text=linktext
+        end
+        s="<a href=#{url}>#{text}</a>"
+        s=blank+s.gsub(/\s/m," ")
       else
-        url=text=linktext
+        s="&lt;web> #{linktext}&lt;/web>"
       end
-      s="<a href=#{url}>#{text}</a>"
-      blank+s.gsub(/\s/m," ")
+      s
     }
   end
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Sending        documentation/ch03.ok
Transmitting file data ..

Now \<web></web> is preserved, at least for HTML.

Well, things like <<END does not work either. Some more care is
necessary. It works for LateX.

Problem: It is not clear how to avoid marking of proper tabs. Since we
use

  <tt>, <web>, <i>, <b> <$....$> <tex>

There must be a way to control whether they are interpreted or not.

Implicit rule: If not in the usual paragraph mode. markup is
suppressed. (I.e., only in verbatim or preformatted mode,)

Explicit way to do markup in listing mode (verbatim etc)

:markuplisting:

Implementation:

Current scheme for latex:

<tex>,<web> processed before putting paragraph mark
other special characters as well.
<tt> etc are processed after putting paragraph mark.


Sun Nov 20 15:38:42 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1477)
+++ acsdoc2.rb	(working copy)
@@ -1326,10 +1326,10 @@
   end
 
   def process_tex_weblinks(instring)
-    ostring=instring.gsub(/(\s)(\\)<web>(.+?)<\/web>/m){ linktext = $3
+    ostring=instring.gsub(/(\s|^)(\\*)<web>(.+?)<\/web>/m){ linktext = $3
       blank=$1
       p linktext  if $DEBUG
-      if $2 != ""
+      if $2 == ""
         if linktext =~ /(.*)\|(.*)/m
           url=($1)
           text=$2
@@ -1339,7 +1339,7 @@
         s="<a href=#{url}>#{text}</a>"
         s=blank+s.gsub(/\s/m," ")
       else
-        s="&lt;web> #{linktext}&lt;/web>"
+        s=blank+"&lt;web>#{linktext}&lt;/web>"
       end
       s
     }
@@ -1347,7 +1347,8 @@
 
 
   def process_some_special_characters(instring)
-    instring.gsub(/\\>/m,">")
+    instring.gsub!(/\\>/m,">")
+    instring.gsub!(/\\</m,"&lt;")
     ostring=""
     instring.each{|x| ostring += expand(x)}
     ostring
@@ -1806,7 +1807,7 @@
     name.gsub(/\.((cp)|(ok))$/,".html")
   end
   def create_navigations_for_cp_files(args)
-    add_navigation_links(args)
+    add_navigation_links(args) if args.size > 1
   end
 
   
@@ -1909,10 +1910,22 @@
 END
       }
   end
+
+  def movetosubdirectory(cplist, directory_name)
+    if File.exist?(directory_name) and not File.directory?(directory_name)
+      raise "#{directory_name} is a file. Cannot move texts there"
+    end
+    Dir.mkdir(directory_name) unless File.exist?(directory_name)
+    if  File.exist?(directory_name+"/.imgs")
+      files = Dir.glob(directory_name+"/.imgs/*")
+      File.delete(*files) if files.size > 0
+      Dir.rmdir(directory_name+"/.imgs") 
+    end
+    system "mv -f  #{cplist.join(" ")} .imgs #{@@stylefilename} #{directory_name}"
+  end
 end
 
-
 # :segment start: acsdoc
 include Acsdoc
 
@@ -2014,19 +2027,10 @@
   create_navigations_for_cp_files(cplist)
   add_html_headeretc(cplist)
   cpfiles.each{|x| make_notice_for_old_page(x[1],x[2])}
+  movetosubdirectory(cplist, directory_name) if directory_name
 end
 
-if directory_name
-  if File.exist?(directory_name) and not File.directory?(directory_name)
-    raise "#{directory_name} is a file. Cannot move texts there"
-  end
-  Dir.mkdir(directory_name) unless File.exist?(directory_name)
-  if  File.exist?(directory_name+"/.imgs")
-    files = Dir.glob(directory_name+"/.imgs/*")
-    File.delete(*files) if files.size > 0
-    Dir.rmdir(directory_name+"/.imgs") 
-  end
-  system "mv -f  #{ARGV.join(" ")} .imgs #{directory_name}"
-end
 
+
+
 # :segment end:
Sending        documentation/Makefile
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..

Minor changes to move directory stuff to module.

Also, hack to suppress \<web> from being processed.
Sun Nov 20 16:40:03 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1478)
+++ acsdoc2.rb	(working copy)
@@ -38,7 +38,7 @@
     "subsubsubsection"]
 
   @@latexlisttypes=[
-    ["paragraph",""],
+    ["paragraph","paragraph"],
     ["ulist*","itemize"],
     ["ulist-","itemize"],
     ["nlist", "enumerate"],
@@ -402,21 +402,19 @@
     end
     ostring
   end
-  
+
   def latex_process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
     s_prev = ""
     ostr=[]
-    ostr.push("\\begin{"+@@latexlisttypes[type][1]+"}")  if new and (type >0)
-
+    ostr.push(":modestart "+@@latexlisttypes[type][1]+":")  if new
     intex = nil
-
-#
-# intex is used to suppress formatting. As you can see from the code below, 
-# suppression can take place only if "<tex>" appears as single item in one 
-# line, and suppression stops only of "</tex>" appears as single item in one
-# line. So if you use them in a more complex ways, it might cause strange 
-# problems.
-#
+    #
+    # intex is used to suppress formatting. As you can see from the code below, 
+    # suppression can take place only if "<tex>" appears as single item in one 
+    # line, and suppression stops only of "</tex>" appears as single item in one
+    # line. So if you use them in a more complex ways, it might cause strange 
+    # problems.
+    #
     while s=instring.shift
       header_candidate =s.split[0] 
       new_item = nil
@@ -425,27 +423,26 @@
 	new_type = type
 	new_indet = indent
 	s1 = s
-      elsif (/^(\*|\-|\d+\.)$/ =~ header_candidate) 
-	new_type = 1+[/\*/,/\-/,/\d+\./].collect{
-	  |x| x=~ header_candidate}.index(0)
-
-	s1 = s.sub(/\S+\s/){|x| " "*x.length} 
-	new_indent = /\S/ =~ s1
-	new_item = 1
+      elsif (header_candidate =~ /^(\*|\-|\d+\.)$/)
+        new_type = 1+[/\*/,/\-/,/\d+\./].collect{|x|
+          x=~ header_candidate}.index(0)
+        s1 = s.sub(/\S+\s/){|x| " "*x.length} 
+        new_indent = /\S/ =~ s1
+        new_item = 1
       else
-	new_indent = /\S/ =~ s
-	new_indent = indent if /^\s*$/ =~s 
-	s1=s
+        new_indent = /\S/ =~ s
+        new_indent = indent if /^\s*$/ =~s 
+        s1=s
       end
       if type == 4 and /^\s+/ =~s 
-	s1 = s
-	new_type=4
-	new_item = nil
+        s1 = s
+        new_type=4
+        new_item = nil
       end
       if new_indent > indent and new_item == nil
 	new_type = 4 
       end
-      s1= process_tex_special_chars(s1) unless new_type == 4
+#      s1= process_tex_special_chars(s1) unless new_type == 4
       if new_indent > indent
 	instring.unshift(s)
 	new=1
@@ -462,12 +459,12 @@
       elsif new_indent == indent
 	if new_item
 	  if new_type != type
-	    ostr.push("\\end{"+@@latexlisttypes[type][1]+"}")
+	    ostr.push(":modeend "+@@latexlisttypes[type][1]+":")
 	    instring.unshift(s)
 	    ostr+= latex_process_single_paragraphs_lists_etc(instring,new_indent,
 						       new_type,1,vlimit)
 	  end
-	  ostr.push("\\item ") if new_type < 4
+	  ostr.push(":item:") if new_type < 4
 	end
 	ostr.push s1
       else
@@ -475,7 +472,7 @@
 	  indent = new_indent
 	  ostr.push s1
 	else
-	  ostr.push("\\end{"+@@latexlisttypes[type][1]+"}")
+	  ostr.push(":modeend "+@@latexlisttypes[type][1]+":")
 	  instring.unshift(s)
 	  return ostr
 	end
@@ -485,6 +482,31 @@
     ostr
   end
 
+  def latex_post_process_paragraphs(instring)
+    ostr=[]
+    inlisting = false
+    while s=instring.shift
+      if s=~ /\:modestart (\S+)\:$/
+        ostr.push "\\begin{#{$1}}" if $1 != "paragraph"
+        inlisting = ($1 == "verbatim") 
+        print "Found  #{$1}, now inlisting=#{inlisting}\n"
+      elsif s=~ /\:modeend (\S+)\:$/
+        inlisting = false
+        print "Found  #{$1}, now inlisting=#{inlisting}\n"
+        ostr.push "\\end{#{$1}}" if $1 != "paragraph"
+      elsif s=~ /\:item\:$/
+        ostr.push "\\item" if $1 != "paragraph"
+      else
+        p s
+        p process_tex_special_chars(s)
+        p inlisting
+        ostr.push(inlisting ? s: process_tex_special_chars(s))
+      end
+    end
+    ostr
+  end
+
+
   def post_process_verbatim(instring)
     ostr=[]
     while s=instring.shift
@@ -529,6 +551,7 @@
     s=latex_process_tex_weblinks(s)
     s=latex_find_and_process_figures(s,dirname)
     s=latex_process_single_paragraphs_lists_etc(s,0,0,1,0)
+    s=latex_post_process_paragraphs(s)
     s=post_process_verbatim(s)
     s=latex_process_link(s)
     s=latex_process_wordmarkup(s,dirname)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1479.

These changes caused too many errors...

Temporarily backed to rev 1478.

Sun Nov 20 17:26:06 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1479)
+++ acsdoc2.rb	(working copy)
@@ -404,6 +404,8 @@
   end
 
   def latex_process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
+    instring = instring.split("\n") if instring.class != Array
+
     s_prev = ""
     ostr=[]
     ostr.push(":modestart "+@@latexlisttypes[type][1]+":")  if new
@@ -419,6 +421,8 @@
       header_candidate =s.split[0] 
       new_item = nil
       new_type = 1
+      @@intex_state = 1 if s == "<tex>" 
+      @@intex_state = 0 if s == "</tex>" 
       if @@intex_state == 1
 	new_type = type
 	new_indet = indent
@@ -495,7 +499,7 @@
         print "Found  #{$1}, now inlisting=#{inlisting}\n"
         ostr.push "\\end{#{$1}}" if $1 != "paragraph"
       elsif s=~ /\:item\:$/
-        ostr.push "\\item" if $1 != "paragraph"
+        ostr.push "\\item " if $1 != "paragraph"
       else
         p s
         p process_tex_special_chars(s)
@@ -649,10 +653,19 @@
     ["nlist", "ol"],
     ["verbatim","pre"]]
 
+  @@htmllisttypes={
+    "paragraph"=>"p",
+    "itemize"->"ul",
+    "nlist"-> "ol",
+    "verbatim"=>"pre"}
 
+
   def process_tex_specials(s)
     s.gsub(/\\<tex>/,"&lt;tex>").gsub(/<\/tex>/,"&lt;/tex>")
   end
+  def process_tex_specials_in_listing(s)
+    s.gsub(/</,"&lt;")
+  end
   def process_single_paragraphs_lists_etc(instring,indent,type,new,vlimit)
     instring = instring.split("\n") if instring.class != Array
     s_prev = ""
@@ -744,6 +757,30 @@
   end
 
 
+
+  def post_process_paragraphs(instring)
+    ostr=[]
+    inlisting = false
+    while s=instring.shift
+      if s=~ /\:modestart (\S+)\:$/
+        ostr.push "<#{@@htmllistyypes[$1]}>"
+        inlisting = ($1 == "verbatim") 
+        print "Found  #{$1}, now inlisting=#{inlisting}\n"
+      elsif s=~ /\:modeend (\S+)\:$/
+        inlisting = false
+        print "Found  #{$1}, now inlisting=#{inlisting}\n"
+        ostr.push "</#{@@htmllistyypes[$1]}>"
+      elsif s=~ /\:item\:$/
+        ostr.push "<li> " if $1 != "paragraph"
+      else
+        ostr.push(inlisting ? process_tex_specials_in_listing(s): process_tex_special_chars(s))
+      end
+    end
+    ostr
+  end
+
+
+
   def setreuseoutput(value)
     @@reuseoutput = value
   end
@@ -1408,7 +1445,8 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2=process_single_paragraphs_lists_etc(tmp2,0,0,1,0).join("\n")
+      tmp2= latex_process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2= post_process_paragraphs(instring).join("\n")
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Sending        documentation/sample.rb
Transmitting file data ..

Rev 1479 edited...
Sun Nov 20 17:43:11 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1480)
+++ acsdoc2.rb	(working copy)
@@ -655,8 +655,8 @@
 
   @@htmllisttypes={
     "paragraph"=>"p",
-    "itemize"->"ul",
-    "nlist"-> "ol",
+    "itemize"=>"ul",
+    "nlist"=> "ol",
     "verbatim"=>"pre"}
 
 
@@ -763,19 +763,19 @@
     inlisting = false
     while s=instring.shift
       if s=~ /\:modestart (\S+)\:$/
-        ostr.push "<#{@@htmllistyypes[$1]}>"
+        ostr.push "<#{@@htmllisttypes[$1]}>"
         inlisting = ($1 == "verbatim") 
-        print "Found  #{$1}, now inlisting=#{inlisting}\n"
       elsif s=~ /\:modeend (\S+)\:$/
         inlisting = false
-        print "Found  #{$1}, now inlisting=#{inlisting}\n"
-        ostr.push "</#{@@htmllistyypes[$1]}>"
+        ostr.push "</#{@@htmllisttypes[$1]}>"
       elsif s=~ /\:item\:$/
         ostr.push "<li> " if $1 != "paragraph"
       else
         ostr.push(inlisting ? process_tex_specials_in_listing(s): process_tex_special_chars(s))
+#        ostr.push(s)
       end
     end
+    p ostr
     ostr
   end
 
@@ -1445,8 +1445,9 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2= latex_process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
-      tmp2= post_process_paragraphs(instring).join("\n")
+      tmp2= process_single_paragraphs_lists_etc(tmp2,0,0,1,0).join("\n")
+#      tmp2= latex_process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+#      tmp2= post_process_paragraphs(tmp2).join("\n")
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1481.

Still not happy for special characters in HTML...

Sun Nov 20 18:02:04 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1481)
+++ acsdoc2.rb	(working copy)
@@ -656,7 +656,7 @@
   @@htmllisttypes={
     "paragraph"=>"p",
     "itemize"=>"ul",
-    "nlist"=> "ol",
+    "enumerate"=> "ol",
     "verbatim"=>"pre"}
 
 
@@ -771,7 +771,7 @@
       elsif s=~ /\:item\:$/
         ostr.push "<li> " if $1 != "paragraph"
       else
-        ostr.push(inlisting ? process_tex_specials_in_listing(s): process_tex_special_chars(s))
+        ostr.push(inlisting ? process_tex_specials_in_listing(s): process_tex_specials(s))
 #        ostr.push(s)
       end
     end
@@ -1445,9 +1445,9 @@
       tmp2= process_tex_labels(tmp2,dirname);
       tmp2= process_tex_weblinks(tmp2)
       tmp2= process_some_special_characters(tmp2)
-      tmp2= process_single_paragraphs_lists_etc(tmp2,0,0,1,0).join("\n")
-#      tmp2= latex_process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
-#      tmp2= post_process_paragraphs(tmp2).join("\n")
+#      tmp2= process_single_paragraphs_lists_etc(tmp2,0,0,1,0).join("\n")
+      tmp2= latex_process_single_paragraphs_lists_etc(tmp2,0,0,1,0)
+      tmp2= post_process_paragraphs(tmp2).join("\n")
       tmp2= process_link(tmp2)
       tmp2=process_wordmarkup(tmp2)
 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1482.

listing in tex mode: Not quite okay for section headers.

Sun Nov 20 18:26:21 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1482)
+++ acsdoc2.rb	(working copy)
@@ -276,7 +276,7 @@
     labeltext=nil
     while s=instring.shift
       header_candidate =s.split[0] 
-      if /^=+$/ =~ header_candidate
+      if /^=+\s/ =~ s
 	header_text = s.sub(/=+/," ")
 	while /^\s+$/ =~ (s = instring.shift )
 	  header_text += s + " "
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1483.

New paragraph does not start correctly within HTML.

Sun Nov 20 18:35:54 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1483)
+++ acsdoc2.rb	(working copy)
@@ -435,7 +435,9 @@
         new_item = 1
       else
         new_indent = /\S/ =~ s
-        new_indent = indent if /^\s*$/ =~s 
+        if /^\s*$/ =~s 
+          new_indent = indent 
+          ostr.push(":modestart paragraph:")if type != 4
         s1=s
       end
       if type == 4 and /^\s+/ =~s 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1484.
Sun Nov 20 18:36:47 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1484)
+++ acsdoc2.rb	(working copy)
@@ -438,6 +438,7 @@
         if /^\s*$/ =~s 
           new_indent = indent 
           ostr.push(":modestart paragraph:")if type != 4
+        end
         s1=s
       end
       if type == 4 and /^\s+/ =~s 
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1485.

Fixed new paragraph.

Sun Nov 20 18:40:26 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1486.
Sun Nov 20 18:40:54 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1487.
Sun Nov 20 18:42:00 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1488.
Mon Nov 21 03:33:48 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1488)
+++ acsdoc2.rb	(working copy)
@@ -183,7 +183,10 @@
   def latex_process_tex_mathmarkup(instring)
     ostring=[]
     while s = instring.shift
-      ostring.push(s.gsub(/<\$(.+?)\$>/){"<tex>$"+$1+"$</tex>"})
+      if s !~ /^(\s+)<\$(.+?)\$>/
+        s.gsub!(/<\$(.+?)\$>/){"<tex>$"+$1+"$</tex>"}
+      end
+      ostring.push s
     end
     ostring
   end
@@ -303,9 +306,9 @@
 	end
 	ostring.push(header)
 	@@latex_section_number+=1
-	print "label and section header ", labeltext, header_text,"\n"
+#	print "label and section header ", labeltext, header_text,"\n"
 	ss = labeltext ? labeltext : header_text
-	p ss
+#	p ss
 	@@latex_section_table.store(ss, @@latex_section_number)
 	ostring.push("\\label{sect:#{@@latex_section_number}}")
 	instring.unshift(s)
@@ -496,17 +499,17 @@
       if s=~ /\:modestart (\S+)\:$/
         ostr.push "\\begin{#{$1}}" if $1 != "paragraph"
         inlisting = ($1 == "verbatim") 
-        print "Found  #{$1}, now inlisting=#{inlisting}\n"
       elsif s=~ /\:modeend (\S+)\:$/
         inlisting = false
-        print "Found  #{$1}, now inlisting=#{inlisting}\n"
         ostr.push "\\end{#{$1}}" if $1 != "paragraph"
       elsif s=~ /\:item\:$/
         ostr.push "\\item " if $1 != "paragraph"
       else
-        p s
-        p process_tex_special_chars(s)
-        p inlisting
+        if $DEBUG
+          p s 
+          p process_tex_special_chars(s)
+          p inlisting
+        end
         ostr.push(inlisting ? s: process_tex_special_chars(s))
       end
     end
@@ -778,7 +781,7 @@
 #        ostr.push(s)
       end
     end
-    p ostr
+    p ostr if $DEBUG
     ostr
   end
 
@@ -884,7 +887,6 @@
       ostring= ostring.chomp+"\n"
       @previous_is_command = true;
     end
-    p ostring
     ostring
   end
 
@@ -1006,29 +1008,29 @@
       lineno += 1
       if s.index("#") == 0
         print "comment line skipped ",s, "\n"
-      elsif s =~ /:in.*code:/ and s.index("\":inccode:\"")==nil
+      elsif s =~ /^(\s*):in.*code:/ and s.index("\":inccode:\"")==nil
 	s.sub!(/:in.*code:/, ':include: ')
         raise "failed to open file #{s.split[1]}" unless file_is_there(s.split[1])
 	ostring = ostring +  @@verbatim_separator
 	ostring = ostring +  s
 	ostring = ostring +  @@verbatim_separator
-      elsif loc = check_tag(s,":output:")
+      elsif  s =~ /^(\s*):output:/
 	ostring = ostring +  add_output(s, dirname, ":output:",fname,lineno)
-      elsif loc = s.index(":commandoutput:")  and s.index("\":commandoutput:\"")==nil
+      elsif  s =~ /^(\s*):commandoutput:/  and s.index("\":commandoutput:\"")==nil
 	ostring = ostring +  add_output(s,  dirname, ":commandoutput:",
 					fname,lineno)
-      elsif loc = s.index(":commandnooutput:")  and s.index("\":commandnooutput:\"")==nil
+      elsif  s=~ /^(\s*):commandnooutput:/  and s.index("\":commandnooutput:\"")==nil
 	ostring = ostring +  add_output(s,  dirname, ":commandnooutput:",
 					fname,lineno)
-      elsif loc = s.index(":command:")  and s.index("\":command:\"")==nil
+      elsif  s=~ /^(\s*):command:/  and s.index("\":command:\"")==nil
 	ostring = ostring +  add_output(s,  dirname, ":command:",
 					fname,lineno)
-      elsif loc = s.index(":prompt:")  and s.index("\":prompt:\"")==nil
+      elsif  s=~/^(\s*):prompt:/ and s.index("\":prompt:\"")==nil
 	set_prompt(s)
-      elsif loc = check_tag(s,":commandinputoutput:")
+      elsif s=~ /^(\s*):commandinputoutput:/
 	ostring = ostring +  command_with_input(s,":commandinputoutput:", 
 				      instring,dirname,true)
-      elsif loc = check_tag(s,":commandinput:")
+      elsif s =~ /^(\s*):commandinput:/
 	ostring = ostring +  command_with_input(s,":commandinput:", instring,
 				      dirname,false)
       else
@@ -2085,7 +2087,7 @@
 
 unless tolatex_flag
   cplist = cpfiles.collect{|x| x[1]}
-  p cplist
+  p cplist if $DEBUG
   add_toc
   process_css
   dump_aux
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1489.

changes not to run commands if :command: etc are not the first word of
a line. Similar change for <$texcode$> (not processed if the first
word with preceeding space chars).



Mon Nov 21 03:36:37 JST 2005
Sending        documentation/acsdoc-rev-memo
Transmitting file data .
Committed revision 1490.
Mon Nov 21 04:43:02 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1490)
+++ acsdoc2.rb	(working copy)
@@ -183,7 +183,7 @@
   def latex_process_tex_mathmarkup(instring)
     ostring=[]
     while s = instring.shift
-      if s !~ /^(\s+)<\$(.+?)\$>/
+      if s !~ /^(\s+)(.+)<\$(.+?)\$>/
         s.gsub!(/<\$(.+?)\$>/){"<tex>$"+$1+"$</tex>"}
       end
       ostring.push s
@@ -534,7 +534,7 @@
   def process_toc_latex(instring)
     ostring=[]
     while s=instring.shift
-      if /:tableofcontents:/ =~ s
+      if /^(\s*):tableofcontents:/ =~ s
 	ostring.push("\\newpage\n\\tableofcontents\n\\newpage\n")
       else
 	ostring.push(s)
@@ -1383,8 +1383,8 @@
 
 @@filefortoc = []
   def process_toc(instring,filename)
-    if instring =~ /:tableofcontents:/
-      instring=instring.gsub(/:tableofcontents:/,"TOCTOCTOCTOC")
+    if instring =~ /^(\s*):tableofcontents:/
+      instring=instring.gsub(/^(\s*):tableofcontents:/,"TOCTOCTOCTOC")
       @@filefortoc.push(filename)
     end
     instring
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Adding         documentation/examples
Adding         documentation/examples/sectionssample.ok
Adding         documentation/examples/simpleexample.ok
Adding         documentation/introduction.ok
Transmitting file data ...

Tue Nov 22 00:45:29 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1492)
+++ acsdoc2.rb	(working copy)
@@ -313,7 +313,7 @@
 	ostring.push("\\label{sect:#{@@latex_section_number}}")
 	instring.unshift(s)
 	labeltext=nil
-      elsif /^---*$/ =~ header_candidate
+      elsif /^---*$/ =~ s
 	if afterverbatim
 	  ostring.push("\\hrule\n\n\\bigskip\n\n")
 	else
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Sending        documentation/introduction.ok
Transmitting file data ..

">" in text, in tex mode, is not quite properly treated yet. In
listing, it should not be changed and that's okay. Current HTML
conversion is also okay.

Should be done in escapetexspecialchatacters...

Tue Nov 22 01:20:27 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1493)
+++ acsdoc2.rb	(working copy)
@@ -69,6 +69,8 @@
     s = instring
     @@charstotexmath.each{|x|
       s=s.gsub(x[0],x[1])}
+    # additional change for ">"...
+    s=s.gsub(/((\\<\w*)|(\s[0-9A-Za-z_`"-+]+)|(\s+))>/){$1+"$>$"}
     s
   end
   
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1494.

Rather dirty hack... but works for most cases.

Next problem: tag replace must be suppressed in verbatim.
This can be done in process_tagmarkup.

Tue Nov 22 01:32:04 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1494)
+++ acsdoc2.rb	(working copy)
@@ -96,8 +96,19 @@
   end
 
   def process_tagmarkup(instring,dirname)
+    instring = instring.split("\n") if instring.class != Array
     ostring = []
-    instring.each{|s| ostring.push(tagmarkup(s))}
+    inlisting = false
+    while s=instring.shift
+      inlisting = true if s =~ /\\begin\{verbatim\}/
+      inlisting = false if s =~ /\\end\{verbatim\}/
+      if inlisting
+        ostring.push(s)
+      else
+        ostring.push(tagmarkup(s))
+      end
+    end
+    ostring
   end
 
   def gettexauxlabel(dirname,label)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1495.

This handled tags. Wordmarkups like *xxx* is not done yet.

Tue Nov 22 01:34:09 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1495)
+++ acsdoc2.rb	(working copy)
@@ -83,8 +83,19 @@
   end
 
   def latex_process_wordmarkup(instring,dirname)
+    instring = instring.split("\n") if instring.class != Array
     ostring = []
-    instring.each{|s| ostring.push(latexwordmarkup(s))}
+    inlisting = false
+    while s=instring.shift
+      inlisting = true if s =~ /\\begin\{verbatim\}/
+      inlisting = false if s =~ /\\end\{verbatim\}/
+      if inlisting
+        ostring.push(s)
+      else
+        ostring.push(latexwordmarkup(s))
+      end
+    end
+    ostring
   end
 
   def tagmarkup(instr)
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1496.

wordmarkup is also fine.

Tue Nov 22 01:45:07 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1496)
+++ acsdoc2.rb	(working copy)
@@ -114,7 +114,7 @@
       inlisting = true if s =~ /\\begin\{verbatim\}/
       inlisting = false if s =~ /\\end\{verbatim\}/
       if inlisting
-        ostring.push(s)
+        ostring.push(s.gsub(/\\<tex>/,"<tex>"))
       else
         ostring.push(tagmarkup(s))
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Transmitting file data ..
Committed revision 1497.
Tue Nov 22 01:50:24 JST 2005
Index: acsdoc2.rb
===================================================================
--- acsdoc2.rb	(revision 1497)
+++ acsdoc2.rb	(working copy)
@@ -114,7 +114,7 @@
       inlisting = true if s =~ /\\begin\{verbatim\}/
       inlisting = false if s =~ /\\end\{verbatim\}/
       if inlisting
-        ostring.push(s.gsub(/\\<tex>/,"<tex>"))
+        ostring.push(s.gsub(/\\<(tex|web)>/){"<"+$1+">"})
       else
         ostring.push(tagmarkup(s))
       end
Sending        documentation/acsdoc-rev-memo
Sending        documentation/acsdoc2.rb
Sending        documentation/introduction.ok
Transmitting file data ..Tue Nov 22 01:54:01 JST 2005
Sending        documentation/acsdoc-rev-memo
Sending        documentation/introduction.ok
Transmitting file data .